<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=2.0, user-scalable=yes" />
    <title>Marketing Dashboard</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --bg: #0F172A;
            --stroke: rgba(148, 163, 184, .12);
            --stroke2: rgba(148, 163, 184, .18);
            --text: #E5E7EB;
            --muted2: #94A3B8;
            --cyan: #22D3EE;
            --good: #39FF88;
            --bad: #FF3B57;
            --shadow: 0 14px 40px rgba(0, 0, 0, .55);
            --r: 18px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
            background: radial-gradient(1200px 800px at 30% 10%, rgba(34, 211, 238, .12), transparent 55%),
                radial-gradient(900px 600px at 70% 30%, rgba(57, 255, 136, .10), transparent 55%),
                linear-gradient(180deg, #0B1220 0%, var(--bg) 55%, #0B1220 100%);
            color: var(--text);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        .mac {
            width: 100%;
            height: 100%;
            border-radius: 0;
            background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .02));
            border: none;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 18px;
            background: rgba(255, 255, 255, .03);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, .05);
            z-index: 10;
        }

        .traffic {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%
        }

        .dot.r {
            background: #FF5F57
        }

        .dot.y {
            background: #FEBB2E
        }

        .dot.g {
            background: #28C840
        }

        .brand {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0;
            font-weight: 800;
            max-height: 50px;
            overflow: hidden;
        }

        .brand .title {
            font-size: 18px;
        }

        .icons {
            display: flex;
            gap: 10px;
            opacity: .8;
        }

        .ico {
            width: 28px;
            height: 28px;
            border-radius: 10px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--stroke);
        }

        .wrap {
            flex: 1;
            display: grid;
            grid-template-columns: 290px 1fr;
            overflow: hidden;
        }

        aside {
            background: rgba(10, 15, 30, 0.4);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, .05);
            padding: 18px 14px;
            overflow: auto;
        }

        .aside-group {
            margin-bottom: 16px;
        }

        .aside-label {
            font-size: 12px;
            color: var(--muted2);
            margin: 2px 8px 10px;
            letter-spacing: .4px;
            text-transform: uppercase;
        }

        .select,
        .input {
            width: 100%;
            background: rgba(255, 255, 255, .035);
            border: 1px solid var(--stroke2);
            border-radius: 12px;
            padding: 10px 12px;
            color: var(--text);
            outline: none;
            font-weight: 700;
        }

        .input[type="date"] {
            padding: 9px 10px;
            font-weight: 800;
            color: rgba(229, 231, 235, .95);
        }

        .row {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .row>* {
            flex: 1
        }

        .hint {
            font-size: 11px;
            color: rgba(148, 163, 184, .9);
            margin: 8px 8px 0;
            line-height: 1.35
        }

        .checks {
            padding: 10px 10px 4px;
            border: 1px solid var(--stroke);
            border-radius: 14px;
            background: rgba(0, 0, 0, .10);
        }

        .chk {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 6px;
            color: var(--text);
            font-weight: 600;
            font-size: 13px;
        }

        .chk input {
            accent-color: var(--cyan);
            width: 16px;
            height: 16px;
        }

        .nav {
            margin-top: 14px;
            padding-top: 10px;
            border-top: 1px solid var(--stroke);
        }

        .nav a {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px 10px;
            border-radius: 12px;
            text-decoration: none;
            color: var(--muted2);
            font-weight: 600;
            font-size: 13px;
            border: 1px solid transparent;
        }

        .nav a.active {
            background: rgba(34, 211, 238, .10);
            border-color: rgba(34, 211, 238, .25);
            color: var(--text);
        }

        .nav .bullet {
            width: 10px;
            height: 10px;
            border-radius: 3px;
            background: rgba(148, 163, 184, .28);
            border: 1px solid rgba(148, 163, 184, .20);
        }

        .nav a.active .bullet {
            background: rgba(34, 211, 238, .75);
            border-color: rgba(34, 211, 238, .35);
            box-shadow: 0 0 0 6px rgba(34, 211, 238, .10);
        }

        main {
            padding: 14px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: auto auto minmax(0, 1fr) auto;
            gap: 12px;
            height: 100%;
            min-width: 0;
            /* Allow shrinking */
        }

        .card {
            background: rgba(20, 30, 50, 0.4);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: var(--r);
            padding: 14px 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, .2);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            animation: fadeIn 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) backwards;
        }

        .alertCard {
            grid-column: 1 / -1;
            grid-row: 2;
            min-height: 0;
            padding: 0;
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, .4), 0 0 0 1px rgba(255, 255, 255, .1);
            border-color: rgba(255, 255, 255, .15);
            background: rgba(25, 35, 60, 0.5);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .kpi {
            grid-column: span 3;
            min-height: 92px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .kpi .label {
            color: var(--muted2);
            font-size: 12px;
            font-weight: 700;
        }

        .kpi .row {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 10px;
            margin-top: 8px;
        }

        .kpi .value {
            font-size: 28px;
            font-weight: 800;
            white-space: nowrap;
        }

        .kpi .delta {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 800;
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid var(--stroke);
            background: rgba(0, 0, 0, .10);
            white-space: nowrap;
        }

        .up {
            color: var(--good)
        }

        .down {
            color: var(--bad)
        }

        .delta .tri {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
        }

        .tri.up {
            border-bottom: 8px solid var(--good)
        }

        .tri.down {
            border-top: 8px solid var(--bad)
        }

        .section-title {
            font-weight: 800;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .subtle {
            color: var(--muted2);
            font-size: 12px;
            font-weight: 600;
        }

        .chartCard,
        .tableCard {
            grid-row: 3;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .bottomFull {
            grid-row: 4;
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .chartCard {
            grid-column: span 7;
        }

        .tableCard {
            grid-column: span 5;
        }


        .bottomRight {
            grid-column: span 5;
        }

        .flex-chart {
            flex: 1;
            min-height: 0;
            position: relative;
            margin-top: 10px;
        }

        .table-container {
            flex: 1;
            overflow: auto;
            margin-top: 10px;
            border-radius: 12px;
            border: 1px solid var(--stroke);
            background: rgba(0, 0, 0, .10);
        }

        /* Remove wrapper styling from table since container handles it */
        table {
            border: none;
            background: transparent;
            border-radius: 0;
        }

        .alert {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid rgba(255, 59, 87, .25);
            background: rgba(255, 59, 87, .08);
            color: #FF98A8;
            font-weight: 800;
        }

        .alert .icon {
            width: 22px;
            height: 22px;
            border-radius: 8px;
            display: grid;
            place-items: center;
            background: rgba(255, 59, 87, .14);
            border: 1px solid rgba(255, 59, 87, .25);
            color: var(--bad);
            font-weight: 900;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th,
        td {
            padding: 12px 12px;
            border-bottom: 1px solid var(--stroke);
            text-align: left;
            white-space: nowrap;
        }

        th {
            color: var(--muted2);
            font-size: 12px;
            font-weight: 900;
            letter-spacing: .3px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .row-strong {
            background: rgba(255, 255, 255, .03);
        }

        .loading {
            grid-column: 1 / -1;
            padding: 18px;
            border: 1px dashed rgba(148, 163, 184, .30);
            border-radius: 16px;
            color: var(--muted2);
            display: flex;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
        }

        .pill {
            padding: 7px 10px;
            border-radius: 999px;
            border: 1px solid var(--stroke);
            background: rgba(0, 0, 0, .12);
            font-weight: 900;
            font-size: 12px;
            color: var(--muted2);
        }

        .small {
            font-size: 12px;
            color: var(--muted2)
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px solid rgba(34, 211, 238, .28);
            background: rgba(34, 211, 238, .12);
            color: var(--text);
            font-weight: 900;
            font-size: 12px;
            cursor: pointer;
            user-select: none;
        }

        .btn:hover {
            background: rgba(34, 211, 238, .16)
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.open {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-container {
            width: min(800px, 94vw);
            max-height: 85vh;
            background: #0f172a;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 18px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
        }

        .modal-title {
            font-weight: 800;
            font-size: 18px;
            color: #fff;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: grid;
            place-items: center;
            transition: background 0.2s;
        }

        .modal-close:hover {
            background: rgba(255, 59, 87, 0.8);
        }

        .modal-body {
            padding: 0;
            overflow: auto;
        }

        .modal-body table {
            border: none;
            background: transparent;
            border-radius: 0;
        }

        .modal-body th {
            position: sticky;
            top: 0;
            background: #0f172a;
            z-index: 10;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .modal-body tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        /* File Cards */
        .file-card {
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .file-card:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: rgba(34, 211, 238, 0.3);
        }

        .file-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .file-name {
            font-weight: 700;
            font-size: 15px;
            color: #fff;
        }

        .file-detail {
            font-size: 13px;
            color: var(--muted2);
            margin-bottom: 6px;
            display: flex;
            gap: 8px;
        }

        .file-detail strong {
            color: #e2e8f0;
            font-weight: 600;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-hot {
            background: rgba(254, 187, 46, 0.15);
            border: 1px solid rgba(254, 187, 46, 0.3);
            color: #FEBB2E;
        }

        .badge-active {
            background: rgba(34, 211, 238, 0.15);
            border: 1px solid rgba(34, 211, 238, 0.3);
            color: #22D3EE;
        }

        .badge-completed {
            background: rgba(57, 255, 136, 0.15);
            border: 1px solid rgba(57, 255, 136, 0.3);
            color: #39FF88;
        }

        .badge-lost {
            background: rgba(255, 59, 87, 0.15);
            border: 1px solid rgba(255, 59, 87, 0.3);
            color: #FF3B57;
        }

        .badge-overdue {
            background: rgba(255, 59, 87, 0.2);
            border: 1px solid rgba(255, 59, 87, 0.4);
            color: #FF3B57;
            animation: pulse 2s infinite;
        }

        /* Clickable Card Hover Effects */
        .card.clickable {
            cursor: pointer;
            transition: all 0.2s;
        }

        .card.clickable:hover {
            transform: translateY(-2px);
            border-color: rgba(34, 211, 238, 0.4);
            box-shadow: 0 8px 24px rgba(34, 211, 238, 0.15);
        }

        .card.clickable:active {
            transform: translateY(0);
        }

        .kpi.clickable:hover {
            transform: scale(1.02);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* --- New Call Center Styles (Tabs & Analytics) --- */

        /* Sticky Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            padding: 8px 8px;
            margin: -14px -14px 16px -14px;
            /* Navigate margin to touch edges of main padding */
            padding-left: 24px;
            border-bottom: 1px solid var(--stroke);
            position: sticky;
            top: 0;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            z-index: 20;
        }

        .tab {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--muted2);
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text);
        }

        .tab.active {
            color: var(--cyan);
            border-bottom-color: var(--cyan);
        }

        /* Analytics Cards */
        .analytics-card {
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--stroke);
            border-radius: var(--r);
            padding: 16px;
            min-height: 280px;
        }

        .analytics-card.full {
            grid-column: span 4;
        }

        .analytics-card.half {
            grid-column: span 2;
        }

        .section-title {
            font-weight: 800;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .compact-chart {
            height: 220px;
            position: relative;
        }
    </style>
</head>

<body>
    <div class="mac">
        <div class="topbar">
            <div class="traffic"><span class="dot r"></span><span class="dot y"></span><span class="dot g"></span></div>
            <div class="brand">
                <div style="font-size:11px; font-weight:700; color:#E5E7EB; line-height:1.1">Consolidated Core</div>
                <div style="font-size:7px; color:#6B7280; margin-top:1px; line-height:1">The Operating System for
                    Nepal's Education Consultancies</div>
                <div style="font-size:13px; color:#60A5FA; margin-top:4px; font-weight:700" id="dashboardTitle">CEO View
                </div>
            </div>
            <div class="icons">
                <div class="ico"></div>
                <div class="ico"></div>
                <div class="ico"></div>
            </div>
        </div>

        <div class="wrap">
            <aside>
                <div class="aside-group">
                    <div class="aside-label">Date Range</div>
                    <select class="select" id="preset">
                        <option value="custom" selected>Custom</option>
                        <option value="this_month">This Month</option>
                        <option value="last_month">Last Month</option>
                        <option value="all_time">All Time</option>
                    </select>

                    <div class="row" style="margin-top:10px">
                        <div>
                            <div class="small" style="margin:0 6px 6px">Start</div>
                            <input class="input" type="date" id="startDate">
                        </div>
                        <div>
                            <div class="small" style="margin:0 6px 6px">End</div>
                            <input class="input" type="date" id="endDate">
                        </div>
                    </div>

                    <div class="hint">
                        Spend data is monthly. If you pick Feb 1–Feb 4, spend will include the month bucket that falls
                        inside the range.
                    </div>
                </div>

                <div class="nav">
                    <a href="#" data-dashboard="ceoview" class="nav-dash"
                        onclick="switchDashboard('ceoview'); return false;"><span class="bullet"></span> CEO View</a>
                    <a href="#" data-dashboard="marketing" class="nav-dash active"
                        onclick="switchDashboard('marketing'); return false;"><span class="bullet"></span> Marketing</a>
                    <a href="#" data-dashboard="callcenter" class="nav-dash"
                        onclick="switchDashboard('callcenter'); return false;"><span class="bullet"></span> Call
                        Center</a>
                    <a href="#" data-dashboard="salesvisa" class="nav-dash"
                        onclick="switchDashboard('salesvisa'); return false;"><span class="bullet"></span> Sales &
                        Visa</a>
                </div>

                <div class="aside-group">
                    <div class="aside-label">Source Filter</div>
                    <div class="checks" id="sourceChecks"></div>
                </div>

                <div style="margin-top:14px" class="small">Data sources: Google Sheets (CSV)</div>
            </aside>

            <main>
                <!-- Marketing View -->
                <div id="viewMarketing" style="display:block">
                    <div class="grid" id="grid">
                        <div class="loading" id="loading">
                            <div>
                                <div style="font-weight:900; color:#E5E7EB">Loading dashboard data…</div>
                                <div class="small">Fetching Marketing Spend + Leads CSV.</div>
                            </div>
                            <div class="pill" id="loadStatus">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Call Center View (Lazy Loaded) -->
                <div id="viewCallCenter" style="display:none">
                    <div class="grid" id="gridCallCenter">
                        <div class="loading">
                            <div>
                                <div style="font-weight:900; color:#E5E7EB">Loading Call Center data…</div>
                                <div class="small">Fetching call metrics and rep performance.</div>
                            </div>
                            <div class="pill" id="loadStatusCC">0%</div>
                        </div>
                    </div>
                </div>

                <!-- Sales & Visa View (Lazy Loaded) -->
                <div id="viewSalesVisa" style="display:none">
                    <div class="grid" id="gridSalesVisa">
                        <div class="loading">
                            <div>
                                <div style="font-weight:900; color:#E5E7EB">Loading Sales & Visa data…</div>
                                <div class="small">Fetching sales pipeline and targets.</div>
                            </div>
                            <div class="pill">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- CEO View (Lazy Loaded) -->
                <div id="viewCeo" style="display:none">
                    <div class="grid" id="gridCeo">
                        <div class="loading">
                            <div>
                                <div style="font-weight:900; color:#E5E7EB">Loading CEO View…</div>
                                <div class="small">Aggregating 360° Company Performance.</div>
                            </div>
                            <div class="pill">Loading...</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal Structure -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle"></div>
                <button class="modal-close" onclick="closeModal()">✕</button>
            </div>
            <div class="modal-body">
                <table>
                    <thead id="modalHead"></thead>
                    <tbody id="modalBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const MARKETING_SPEND_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_6sdL4MsE0nUKfC_IyV0lbk9D81bYT3Z58ZPzk2HBE0MZX_pVjpQdMF_gKfJS_0tY6uDTHUvg8OIQ/pub?gid=1245492023&single=true&output=csv";
        const LEADS_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_6sdL4MsE0nUKfC_IyV0lbk9D81bYT3Z58ZPzk2HBE0MZX_pVjpQdMF_gKfJS_0tY6uDTHUvg8OIQ/pub?gid=0&single=true&output=csv";
        const CALL_CENTER_API = "https://script.google.com/macros/s/AKfycbw3z6vZdTbsS0MrVeGeDirN62h0LWkdfXsNAfHbKTIlD10MIRFcUPCmxYDnKYy9uSiBUw/exec";
        const SALES_VISA_API = "https://script.google.com/macros/s/AKfycbzfcR-Run4kf3yDiJbjTKKMT2a8hvnyQodR3MXtArhhnsB5nQ5EFIXVeH89Vb1Ek2HHUQ/exec";

        // Global data storage for modals
        let globalSalesData = [];

        function $(id) { return document.getElementById(id); }

        function parseCSV(text) {
            const rows = [];
            let row = [], cell = "", inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (c === '"') {
                    if (inQuotes && text[i + 1] === '"') { cell += '"'; i++; }
                    else inQuotes = !inQuotes;
                } else if (c === "," && !inQuotes) {
                    row.push(cell); cell = "";
                } else if ((c === "\n" || c === "\r") && !inQuotes) {
                    if (c === "\r" && text[i + 1] === "\n") i++;
                    row.push(cell);
                    if (row.length > 1 || row[0].trim() !== "") rows.push(row);
                    row = []; cell = "";
                } else {
                    cell += c;
                }
            }
            row.push(cell);
            if (row.length > 1 || row[0].trim() !== "") rows.push(row);

            const header = rows.shift().map(h => h.trim());
            return rows.map(r => {
                const obj = {};
                header.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
                return obj;
            });
        }

        function parseDateAny(s) {
            if (!s) return null;
            const t = String(s).trim();
            if (/^\d{4}-\d{2}-\d{2}/.test(t)) {
                const d = new Date(t);
                return isNaN(d) ? null : d;
            }
            const m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
            if (m) {
                const d = new Date(Number(m[3]), Number(m[1]) - 1, Number(m[2]));
                return isNaN(d) ? null : d;
            }
            return null;
        }

        function toISODate(d) {
            const yyyy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const dd = String(d.getDate()).padStart(2, "0");
            return `${yyyy}-${mm}-${dd}`;
        }

        function safeNum(x) {
            const n = Number(String(x).replace(/[^0-9.\-]/g, ""));
            return isFinite(n) ? n : 0;
        }
        function formatNPR(n) {
            if (!isFinite(n)) return "NPR 0";
            return "NPR " + Math.round(n).toLocaleString("en-US");
        }
        function pctDelta(curr, prev) {
            if (!isFinite(curr) || !isFinite(prev) || prev === 0) return null;
            return ((curr - prev) / prev) * 100;
        }
        function normalizeSource(s) {
            const t = (s || "").trim();
            if (!t) return "Unknown";
            const low = t.toLowerCase();
            if (low.includes("facebook")) return "Facebook";
            if (low.includes("tiktok")) return "TikTok";
            if (low.includes("walk")) return "Walk-in";
            if (low.includes("insta")) return "Instagram";
            if (low.includes("google")) return "Google";
            if (low.includes("refer")) return "Referral";
            if (low.includes("other")) return "Other";
            return t;
        }

        let spendRows = [], leadRows = [], targetRows = [];
        let charts = {};
        let currentData = null; // Store aggregated data for modals

        let globalRawData = null; // Store raw marketing data
        let globalCCData = null; // Store raw call center data
        let currentTab = "marketing"; // Track active tab

        // Render cache flags
        let marketingRendered = false;
        let callCenterRendered = false;

        // Dashboard Lazy Loading Cache
        let dashboardCache = {
            marketing: { loaded: false },
            callcenter: { loaded: false },
            salesvisa: { loaded: false }
        };
        let currentDashboard = 'marketing';

        async function fetchText(url) {
            const res = await fetch(url, { cache: "no-store", mode: "cors" });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            return await res.text();
        }

        async function fetchData() {
            const status = $("loadStatus");
            status.textContent = "10%";
            const [spendText, leadText] = await Promise.all([
                fetchText(MARKETING_SPEND_CSV + "&t=" + Date.now()),
                fetchText(LEADS_CSV + "&t=" + Date.now())
            ]);
            status.textContent = "60%";
            // Custom parsing for Spend CSV to handle dual tables
            const rawSpendRows = parseCSVToGrid(spendText);
            spendRows = rawSpendRows.map(r => ({
                "Month": r[0], "Source": r[1], "Amount Spent (NPR)": r[2]
            })).filter(r => r["Month"] && r["Source"]);

            targetRows = rawSpendRows.map(r => ({
                "Month": r[5], "Lead Target": r[6]
            })).filter(r => r["Month"] && r["Lead Target"]);

            leadRows = parseCSV(leadText);
            status.textContent = "75%";

            // Fetch Call Center data
            try {
                await fetchCCData();
                status.textContent = "90%";
            } catch (e) {
                console.warn("Failed to load Call Center data:", e);
                globalCCData = []; // Empty array if fetch fails
                status.textContent = "90%";
            }
        }

        async function fetchCCData() {
            try {
                const res = await fetch(CALL_CENTER_API);
                const json = await res.json();

                // Handle various API response formats
                let data = [];
                if (Array.isArray(json)) {
                    data = json;
                } else if (json && Array.isArray(json.data)) {
                    data = json.data;
                } else if (json && Array.isArray(json.result)) {
                    data = json.result;
                } else {
                    console.error("Unknown API response format:", json);
                    throw new Error("API did not return a list of rows");
                }

                // Store raw data
                globalCCData = data;

                console.log(`✅ Loaded ${data.length} Call Center rows`);
                return data;
            } catch (err) {
                console.error(err);
                throw err;
            }
        }

        function getRangeDates() {
            const start = new Date($("startDate").value + "T00:00:00");
            const end = new Date($("endDate").value + "T23:59:59");
            return { start, end };
        }

        function parseCSVToGrid(text) {
            const rows = [];
            let row = [], cell = "", inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const c = text[i];
                if (c === '"') {
                    if (inQuotes && text[i + 1] === '"') { cell += '"'; i++; }
                    else inQuotes = !inQuotes;
                } else if (c === "," && !inQuotes) {
                    row.push(cell); cell = "";
                } else if ((c === "\n" || c === "\r") && !inQuotes) {
                    if (c === "\r" && text[i + 1] === "\n") i++;
                    row.push(cell);
                    if (row.length > 1 || row[0].trim() !== "") rows.push(row);
                    row = []; cell = "";
                } else {
                    cell += c;
                }
            }
            row.push(cell);
            if (row.length > 1 || row[0].trim() !== "") rows.push(row);
            rows.shift(); // remove header
            return rows;
        }

        function allDates() {
            const ds = [];
            spendRows.forEach(r => { const d = parseDateAny(r["Month"]); if (d) ds.push(d); });
            leadRows.forEach(r => { const d = parseDateAny(r["Date"]); if (d) ds.push(d); });
            ds.sort((a, b) => a - b);
            return ds;
        }

        function setRangePreset(preset) {
            const ds = allDates();
            if (!ds.length) return;
            const minD = ds[0];
            const maxD = ds[ds.length - 1];

            if (preset === "all_time") {
                $("startDate").value = toISODate(minD);
                $("endDate").value = toISODate(maxD);
                return;
            }

            // Use the latest date in data (not today's date) so presets always work
            const ref = maxD;
            if (preset === "this_month") {
                const start = new Date(ref.getFullYear(), ref.getMonth(), 1);
                const end = new Date(ref.getFullYear(), ref.getMonth() + 1, 0);
                $("startDate").value = toISODate(start);
                $("endDate").value = toISODate(end);
                return;
            }

            if (preset === "last_month") {
                const start = new Date(ref.getFullYear(), ref.getMonth() - 1, 1);
                const end = new Date(ref.getFullYear(), ref.getMonth(), 0);
                $("startDate").value = toISODate(start);
                $("endDate").value = toISODate(end);
                return;
            }
        }

        function getSelectedSources() {
            const labels = [...$("sourceChecks").querySelectorAll("label.chk")];
            const selected = [];
            labels.forEach(l => {
                if (l.querySelector("input").checked) selected.push(l.querySelector("span").textContent);
            });
            return new Set(selected);
        }

        function buildSourceFilter() {
            const sources = new Set();
            spendRows.forEach(r => sources.add(normalizeSource(r["Source"])));
            leadRows.forEach(r => sources.add(normalizeSource(r["Source"])));
            const order = ["Facebook", "TikTok", "Walk-in", "Instagram", "Google", "Referral", "Other", "Unknown"];
            const ordered = order.filter(s => sources.has(s)).concat([...sources].filter(s => !order.includes(s)).sort());

            const box = $("sourceChecks");
            box.innerHTML = "";
            ordered.forEach((s, idx) => {
                const id = `src_${idx}`;
                const div = document.createElement("label");
                div.className = "chk";
                div.innerHTML = `<input type="checkbox" id="${id}" checked> <span>${s}</span>`;
                box.appendChild(div);
                div.querySelector("input").addEventListener("change", render);
            });
        }

        function getRange() {
            const s = $("startDate").value;
            const e = $("endDate").value;
            const start = s ? new Date(s + "T00:00:00") : null;
            const end = e ? new Date(e + "T23:59:59") : null;
            if (!start || !end || isNaN(start) || isNaN(end)) return null;
            return { start, end };
        }

        function previousRange(curr) {
            // same number of days immediately before current range
            const msDay = 24 * 60 * 60 * 1000;
            const days = Math.round((curr.end - curr.start) / msDay) + 1;
            const prevEnd = new Date(curr.start.getTime() - msDay);
            const prevStart = new Date(prevEnd.getTime() - (days - 1) * msDay);
            return { start: prevStart, end: prevEnd };
        }

        function inRange(d, r) {
            return d && r && d >= r.start && d <= r.end;
        }

        function compute() {
            const r = getRange();
            if (!r) return null;
            const prev = previousRange(r);
            const selectedSources = getSelectedSources();

            // Spend: monthly buckets. Include month "date" if it falls within selected range.
            let spendCurr = 0, spendPrev = 0;
            const bySourceSpendCurr = new Map();
            const filteredSpend = [];

            spendRows.forEach(row => {
                const d = parseDateAny(row["Month"]);
                const src = normalizeSource(row["Source"]);
                if (!selectedSources.has(src)) return;
                const amt = safeNum(row["Amount Spent (NPR)"] || row["Amount Spent"] || row["Spend"]);

                if (inRange(d, r)) {
                    spendCurr += amt;
                    bySourceSpendCurr.set(src, (bySourceSpendCurr.get(src) || 0) + amt);
                    filteredSpend.push(row);
                }
                if (inRange(d, prev)) {
                    spendPrev += amt;
                }
            });

            // Leads: Use unique Client IDs from both Marketing and Call Center data
            const clientIDsCurr = new Set();
            const clientIDsPrev = new Set();
            let unknownCurr = 0;
            const bySourceCurr = new Map();
            const filteredLeads = [];
            let disqualifiedCurr = 0, disqualifiedPrev = 0;

            // Process Marketing leads first
            leadRows.forEach(row => {
                const d = parseDateAny(row["Date"]);
                const src = normalizeSource(row["Source"]);
                if (!selectedSources.has(src)) return;

                const clientID = row["Client ID"] || row["ClientID"] || row["ID"];
                const stage = (row["Stage"] || "").trim().toLowerCase();
                const isDisqualified = stage === "disqualified" || stage === "unqualified";
                const isUnknown = (src === "Unknown" || src === "Other");

                if (inRange(d, r)) {
                    if (clientID) {
                        if (!clientIDsCurr.has(clientID)) {
                            clientIDsCurr.add(clientID);
                            if (isUnknown) unknownCurr += 1;
                            bySourceCurr.set(src, (bySourceCurr.get(src) || 0) + 1);
                            filteredLeads.push(row);
                        }
                    } else {
                        // No Client ID, count it anyway
                        if (isUnknown) unknownCurr += 1;
                        bySourceCurr.set(src, (bySourceCurr.get(src) || 0) + 1);
                        filteredLeads.push(row);
                    }
                    if (isDisqualified) disqualifiedCurr += 1;
                }
                if (inRange(d, prev)) {
                    if (clientID && !clientIDsPrev.has(clientID)) {
                        clientIDsPrev.add(clientID);
                    }
                    if (isDisqualified) disqualifiedPrev += 1;
                }
            });

            // Process Call Center data - only add if Client ID is NOT already in Marketing
            if (globalCCData && globalCCData.length > 0) {
                globalCCData.forEach(row => {
                    const d = parseDateAny(row["Date"]);
                    const src = normalizeSource(row["Source"]);
                    const clientID = row["Client ID"] || row["ClientID"] || row["ID"];

                    if (!selectedSources.has(src)) return;
                    if (!inRange(d, r)) return;

                    const stage = (row["Stage"] || "").trim().toLowerCase();
                    const isDisqualified = stage === "disqualified" || stage === "unqualified";
                    const isUnknown = (src === "Unknown" || src === "Other");

                    if (inRange(d, r)) {
                        if (clientID && !clientIDsCurr.has(clientID)) {
                            clientIDsCurr.add(clientID);
                            if (isUnknown) unknownCurr += 1;
                            bySourceCurr.set(src, (bySourceCurr.get(src) || 0) + 1);
                        }
                        if (isDisqualified) disqualifiedCurr += 1;
                    }
                    if (inRange(d, prev)) {
                        if (clientID && !clientIDsPrev.has(clientID)) {
                            clientIDsPrev.add(clientID);
                        }
                        if (isDisqualified) disqualifiedPrev += 1;
                    }
                });
            }

            // Total leads = unique Client IDs
            const leadsCurr = clientIDsCurr.size;
            const leadsPrev = clientIDsPrev.size;

            // Qualified = Total - Disqualified/Unqualified
            const qualifiedCurr = leadsCurr - disqualifiedCurr;
            const qualifiedPrev = leadsPrev - disqualifiedPrev;

            const cplqCurr = qualifiedCurr > 0 ? spendCurr / qualifiedCurr : 0;
            const cplqPrev = qualifiedPrev > 0 ? spendPrev / qualifiedPrev : 0;

            const unkPct = leadsCurr > 0 ? (unknownCurr / leadsCurr) * 100 : 0;

            const sources = [...new Set([...bySourceCurr.keys(), ...bySourceSpendCurr.keys()])];
            const order = ["Facebook", "TikTok", "Walk-in", "Instagram", "Google", "Referral", "Other", "Unknown"];
            sources.sort((a, b) => {
                const ia = order.indexOf(a), ib = order.indexOf(b);
                if (ia !== -1 && ib !== -1) return ia - ib;
                if (ia !== -1) return -1;
                if (ib !== -1) return 1;
                return a.localeCompare(b);
            });

            const leaderboard = sources.map(src => {
                const spend = bySourceSpendCurr.get(src) || 0;
                const leads = bySourceCurr.get(src) || 0;
                const cost = leads > 0 ? (spend / leads) : 0;
                return { src, spend, cost, leads };
            });



            // Target Calculations
            const refDate = r.end;
            const curMonthStart = new Date(refDate.getFullYear(), refDate.getMonth(), 1);
            const curMonthEnd = new Date(refDate.getFullYear(), refDate.getMonth() + 1, 0);

            const curYearStart = new Date(refDate.getFullYear(), 0, 1);
            const curYearEnd = new Date(refDate.getFullYear(), 11, 31);

            const q = Math.floor(refDate.getMonth() / 3);
            const curQStart = new Date(refDate.getFullYear(), q * 3, 1);
            const curQEnd = new Date(refDate.getFullYear(), q * 3 + 3, 0);

            function getProgress(s, e) {
                let actual = 0;
                leadRows.forEach(row => {
                    const d = parseDateAny(row["Date"]);
                    if (d && d >= s && d <= e) actual++;
                });

                let target = 0;
                targetRows.forEach(row => {
                    const d = parseDateAny(row["Month"]);
                    const t = safeNum(row["Lead Target"]);
                    // Targets are defined by Month start.
                    // If a target month falls within the period, include it.
                    if (d && d >= s && d <= e) target += t;
                });

                // Avoid DBZ
                const pct = target > 0 ? Math.min(100, (actual / target) * 100) : 0;
                return { actual, target, pct };
            }

            const tMonth = getProgress(curMonthStart, curMonthEnd);
            const tQuarter = getProgress(curQStart, curQEnd);
            const tYear = getProgress(curYearStart, curYearEnd);

            return { r, prev, spendCurr, spendPrev, leadsCurr, leadsPrev, qualifiedCurr, qualifiedPrev, cplqCurr, cplqPrev, unkPct, leaderboard, filteredSpend, filteredLeads, targets: { tMonth, tQuarter, tYear } };
        }

        function kpiCard({ label, value, deltaPct, goodWhenUp = true, delay = 0, action = "" }) {
            const isUp = deltaPct !== null && deltaPct >= 0;
            const good = goodWhenUp ? isUp : !isUp;
            const cls = good ? "up" : "down";
            const tri = isUp ? "up" : "down";
            const deltaText = (deltaPct === null) ? "—" : `${Math.abs(deltaPct).toFixed(0)}%`;
            return `
      <div class="card kpi" style="animation-delay: ${delay * 50}ms; cursor:pointer" onclick="${action}">
        <div class="label">${label}</div>
        <div class="row">
          <div class="value">${value}</div>
          <div class="delta ${cls}">
            <span class="tri ${tri}"></span>
            ${deltaText}
          </div>
        </div>
      </div>`;
        }

        function render(forceRender = false) {
            // Skip if already rendered unless forced
            if (marketingRendered && !forceRender) {
                return;
            }

            const data = compute();
            if (!data) return;

            currentData = data; // Save to global

            const grid = $("grid");
            grid.innerHTML = "";

            const spendDelta = pctDelta(data.spendCurr, data.spendPrev);
            const leadsDelta = pctDelta(data.leadsCurr, data.leadsPrev);
            const qualDelta = pctDelta(data.qualifiedCurr, data.qualifiedPrev);
            const cplqDelta = pctDelta(data.cplqCurr, data.cplqPrev);

            grid.insertAdjacentHTML("beforeend", `
      ${kpiCard({ label: "Total Ad Spend", value: formatNPR(data.spendCurr), deltaPct: spendDelta, goodWhenUp: false, delay: 0, action: "openDetails('spend')" })}
      ${kpiCard({ label: "Total Leads Generated", value: data.leadsCurr.toLocaleString("en-US"), deltaPct: leadsDelta, goodWhenUp: true, delay: 1, action: "openDetails('leads')" })}
      ${kpiCard({ label: "Qualified Leads", value: data.qualifiedCurr.toLocaleString("en-US"), deltaPct: qualDelta, goodWhenUp: true, delay: 2, action: "openDetails('leads')" })}
      ${kpiCard({ label: "Cost Per Qualified Lead", value: formatNPR(data.cplqCurr), deltaPct: cplqDelta, goodWhenUp: false, delay: 3, action: "openDetails('spend')" })}
    `);

            grid.insertAdjacentHTML("beforeend", `
      <div class="card alertCard">
         <div class="alert" style="cursor:pointer" onclick="openDetails('leads', 'Unknown')">
           <span class="icon">!</span>
           <span>⚠️ Unknown Source: ${data.unkPct.toFixed(0)}% (Click to view)</span>
         </div>
      </div>
    `);

            grid.insertAdjacentHTML("beforeend", `
      <div class="card chartCard" style="animation-delay: 150ms">
        <div class="section-title">Quality Ratio</div>
        <div class="subtle">Qualified vs Junk by Source</div>
        <div class="flex-chart"><canvas id="qualityChart"></canvas></div>
      </div>

      <div class="card tableCard" style="animation-delay: 200ms">
        <div class="section-title">Lead Source Leaderboard</div>
        <div class="subtle">Spend vs Cost/Qual Lead</div>
        <div class="table-container">
          <table>
            <thead><tr><th style="width:45%">Source</th><th style="width:20%">Spend</th><th style="width:20%">Cost/Qual Lead</th><th style="width:15%">Leads</th></tr></thead>
            <tbody id="leaderBody"></tbody>
          </table>
        </div>
      </div>
    `);

            const body = $("leaderBody");
            body.innerHTML = "";
            data.leaderboard.forEach(r => {
                const strong = (r.src === "Facebook");
                body.insertAdjacentHTML("beforeend", `
        <tr class="${strong ? "row-strong" : ""}">
          <td style="font-weight:900">${r.src}</td>
          <td>${formatNPR(r.spend)}</td>
          <td style="font-weight:900">${formatNPR(r.cost)}</td>
          <td style="font-weight:900">${r.leads.toLocaleString("en-US")}</td>
        </tr>
      `);
            });

            // Clean up old charts
            Object.values(charts).forEach(c => { try { c.destroy(); } catch (e) { } });
            charts = {};

            // Re-create Quality Chart
            const chartData = data.leaderboard.filter(x => x.leads > 0);
            const labels = chartData.map(x => x.src);
            const leadMap = new Map(chartData.map(x => [x.src, x.leads]));
            const qData = labels.map(s => leadMap.get(s) || 0);
            const junkData = labels.map(_ => 0);

            const qctx = document.getElementById("qualityChart").getContext("2d");
            charts.quality = new Chart(qctx, {
                type: "bar",
                data: {
                    labels, datasets: [
                        { label: "Qualified", data: qData, backgroundColor: "rgba(57,255,136,.85)", borderRadius: 10, stack: "s" },
                        { label: "Junk", data: junkData, backgroundColor: "rgba(255,59,87,.85)", borderRadius: 10, stack: "s" }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    onClick: (e, elements, chart) => {
                        if (!elements || elements.length === 0) return;
                        const i = elements[0].index;
                        const label = chart.data.labels[i];
                        openDetails('leads', label);
                    },
                    plugins: { legend: { labels: { color: "#e2e8f0", boxWidth: 12, boxHeight: 12, font: { family: 'Inter', weight: '600' }, usePointStyle: true } } },
                    scales: {
                        x: { ticks: { color: "#e2e8f0", font: { family: 'Inter', weight: '600', size: 12 } }, grid: { display: false } },
                        y: { ticks: { color: "#94a3b8", font: { family: 'Inter', size: 11 } }, grid: { color: "rgba(255,255,255,0.05)" }, beginAtZero: true }
                    },
                    devicePixelRatio: window.devicePixelRatio || 2
                }
            });

            grid.insertAdjacentHTML("beforeend", `
      <div class="card bottomFull" style="height: 240px; display:flex; flex-direction:row; gap:20px; align-items:center; justify-content:space-around">
        ${renderGauge("Monthly Target", data.targets.tMonth, "gaugeMonth")}
        ${renderGauge("Quarterly Target", data.targets.tQuarter, "gaugeQuarter")}
        ${renderGauge("Yearly Target", data.targets.tYear, "gaugeYear")}
      </div>
    `);

            // Draw Gauges
            drawGauge("gaugeMonth", data.targets.tMonth.pct, "gMonth");
            drawGauge("gaugeQuarter", data.targets.tQuarter.pct, "gQuarter");
            drawGauge("gaugeYear", data.targets.tYear.pct, "gYear");
        }

        function renderGauge(title, metrics, id) {
            return `
            <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                <div class="section-title" style="margin-bottom:4px">${title}</div>
                <div class="subtle" style="margin-bottom:12px">${metrics.actual} / ${metrics.target}</div>
                <div style="width:100%; height:140px; position:relative">
                    <canvas id="${id}"></canvas>
                </div>
            </div>`;
        }

        function drawGauge(id, val, key) {
            const ctx = document.getElementById(id).getContext("2d");
            if (charts[key]) charts[key].destroy(); // Destroy existing chart instance if it exists
            charts[key] = new Chart(ctx, {
                type: "doughnut",
                data: { datasets: [{ data: [val, 100 - val], backgroundColor: ["rgba(34,211,238,.9)", "rgba(148,163,184,.18)"], borderWidth: 0, cutout: "75%" }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    rotation: -90,
                    circumference: 180,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    devicePixelRatio: window.devicePixelRatio || 2
                },
                plugins: [{
                    id: "centerText",
                    afterDraw(chart) {
                        const meta = chart.getDatasetMeta(0).data[0];
                        if (!meta) return;
                        const { ctx } = chart;
                        ctx.save();
                        ctx.fillStyle = "rgba(229,231,235,.95)";
                        ctx.font = "800 28px Inter";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.fillText(val.toFixed(0) + "%", meta.x, meta.y - 15);
                        ctx.restore();
                    }
                }]
            });

            // Mark as rendered
            marketingRendered = true;
        }

        function showFallbackUploader(errorMsg) {
            const grid = $("grid");
            grid.innerHTML = `
      <div class="card" style="grid-column:1/-1">
        <div class="section-title">Failed to load CSV</div>
        <div class="small" style="margin-top:6px;color:#FF98A8;font-weight:800">${errorMsg}</div>

        <div style="margin-top:14px" class="small">
          If you opened the dashboard as a local file (file://), the browser may block Google Sheets fetch (CORS).
        </div>

        <div class="card" style="margin-top:12px;background:rgba(0,0,0,.10);border:1px solid rgba(148,163,184,.18)">
          <div style="font-weight:900">Fix: run a tiny local server</div>
          <div class="small" style="margin-top:8px;font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Courier New', monospace; color:#E5E7EB">
            python -m http.server 8000
          </div>
          <div class="small" style="margin-top:8px">Open: http://localhost:8000</div>
        </div>
      </div>`;
        }

        async function init() {
            try {
                await fetchData();


                $("loadStatus").textContent = "100%";
                $("loading").remove();

                buildSourceFilter();

                // Default: This Month based on latest data
                $("preset").value = "this_month";
                setRangePreset("this_month");

                // UX: Inputs disabled by default
                $("startDate").disabled = true;
                $("endDate").disabled = true;

                render();

                const handleDateChange = () => {
                    marketingRendered = false; // Invalidate marketing cache

                    if (currentDashboard === 'marketing') {
                        render(true);
                    } else if (currentDashboard === 'callcenter') {
                        renderCallCenter();
                    } else if (currentDashboard === 'salesvisa' && window.globalSalesData) {
                        renderSalesVisa(window.globalSalesData);
                    } else if (currentDashboard === 'ceoview') {
                        renderCeoView();
                    }
                };

                // Add date input event listeners
                $("startDate").addEventListener("change", handleDateChange);
                $("endDate").addEventListener("change", handleDateChange);

                // Add preset dropdown event listener
                $("preset").addEventListener("change", function () {
                    const val = this.value;
                    setRangePreset(val);

                    // UX: Disable manual inputs unless Custom
                    const isCustom = val === "custom";
                    $("startDate").disabled = !isCustom;
                    $("endDate").disabled = !isCustom;

                    // Trigger render for active dashboard
                    handleDateChange();
                });

                // Start fetching Call Center data in background immediately
                // We don't await this here, so Marketing renders instantly
                callCenterPromise = fetchCCData().catch(e => console.warn("Background fetch failed:", e));

            } catch (e) {
                console.error(e);
                if ($("loading")) $("loading").remove();
                showFallbackUploader(e.message);
            }
        }

        // --- Dashboard Switching Logic (Lazy Loading) ---
        async function switchDashboard(name) {
            console.log(`🔄 Switching to: ${name}`);
            currentDashboard = name;

            // Hide all views
            $('viewMarketing').style.display = 'none';
            $('viewCallCenter').style.display = 'none';
            $('viewSalesVisa').style.display = 'none';
            if ($('viewCeo')) $('viewCeo').style.display = 'none';

            // Update sidebar active state
            document.querySelectorAll('.nav-dash').forEach(a => {
                if (a.getAttribute('data-dashboard') === name) {
                    a.classList.add('active');
                } else {
                    a.classList.remove('active');
                }
            });

            // Update dashboard title in header
            const titleMap = {
                'ceoview': 'CEO View',
                'marketing': 'Marketing Dashboard',
                'callcenter': 'Call Center',
                'salesvisa': 'Sales & Visa'
            };
            const titleElement = document.getElementById('dashboardTitle');
            if (titleElement && titleMap[name]) {
                titleElement.textContent = titleMap[name];
            }

            // Show selected view
            const viewMap = {
                marketing: 'viewMarketing',
                callcenter: 'viewCallCenter',
                salesvisa: 'viewSalesVisa',
                ceoview: 'viewCeo'
            };
            const targetId = viewMap[name];
            if (targetId && $(targetId)) {
                $(targetId).style.display = 'block';
            } else {
                console.error(`View not found for dashboard: ${name}`);
            }

            // Load data if not cached
            if (name === 'marketing') {
                if (!marketingRendered) {
                    console.log('✅ Loading Marketing data...');
                    render();
                    marketingRendered = true;
                }
            } else if (name === 'callcenter') {
                // ALWAYS load fresh data for Call Center (per user request)
                console.log('✅ Loading Call Center data (Fresh)...');
                ccLoaded = false; // Reset loaded flag
                await loadCallCenterData();
            } else if (name === 'salesvisa') {
                if (!dashboardCache.salesvisa.loaded) {
                    console.log('✅ Loading Sales & Visa data...');
                    await loadSalesVisaData();
                    dashboardCache.salesvisa.loaded = true;
                }
            } else if (name === 'ceoview') {
                console.log('✅ Loading CEO View...');
                await renderCeoView();
            }

            currentDashboard = name;
        }

        let callCenterPromise = null;
        let ccLoaded = false;
        let isCCLoading = false;

        async function loadCallCenterData() {
            if (isCCLoading) {
                console.log("⚠️ Call Center load already in progress, skipping...");
                return;
            }
            isCCLoading = true;
            console.log("📞 loadCallCenterData() called");

            const updateProgress = (pct) => {
                const status = $("loadStatusCC");
                if (status) status.textContent = pct + "%";
                const pill = $("loadStatusCC2");
                if (pill) pill.textContent = pct + "%";
            };

            updateProgress(5);

            // Check localStorage cache first
            const CACHE_KEY = "ccDataCache";
            const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

            try {
                const cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    const age = Date.now() - timestamp;

                    if (age < CACHE_DURATION) {
                        console.log(`✅ Using cached Call Center data (${Math.round(age / 1000)}s old)`);
                        globalCCData = data;
                        ccLoaded = true;
                        updateProgress(100);
                        renderCallCenter();
                        isCCLoading = false;

                        // Update Sales Dashboard if active
                        if (currentDashboard === "salesvisa" && window.globalSalesData) {
                            console.log("🔄 Updating Sales Dashboard with cached CC data...");
                            renderSalesVisa(window.globalSalesData);
                        }
                        return;
                    } else {
                        console.log(`⏱️ Cache expired (${Math.round(age / 1000)}s old), fetching fresh data...`);
                    }
                }
            } catch (e) {
                console.warn("⚠️ Cache read error:", e);
            }

            // If already loaded in memory, use that
            if (ccLoaded) {
                console.log("✅ Call Center already loaded in memory, rendering...");
                updateProgress(100);
                renderCallCenter();
                isCCLoading = false;
                return;
            }

            const grid = $("gridCallCenter");
            updateProgress(10);

            if (grid && currentDashboard === "callcenter") {
                grid.innerHTML = `
                    <div class="card" style="grid-column:1/-1; text-align:center; padding:40px">
                        <div style="font-size:24px; margin-bottom:20px">🔄 Connecting to Call Center API...</div>
                        <div style="color:var(--muted2)">Please wait</div>
                        <div class="pill" style="margin-top:15px" id="loadStatusCC2">10%</div>
                    </div>
                `;
            }

            updateProgress(20);

            try {
                console.log("🌐 Fetching Call Center data from API...");
                updateProgress(30);

                // Always fetch fresh promise if forcing reload
                callCenterPromise = fetchCCData();

                updateProgress(50);
                await callCenterPromise;
                updateProgress(80);

                ccLoaded = true;
                console.log("✅ Call Center data fetched successfully");

                // Save to localStorage cache
                try {
                    const cacheData = {
                        data: globalCCData,
                        timestamp: Date.now()
                    };
                    localStorage.setItem("ccDataCache", JSON.stringify(cacheData));
                    console.log("💾 Call Center data cached to localStorage");
                } catch (e) {
                    console.warn("⚠️ Failed to cache data:", e);
                }

                if (currentDashboard === "callcenter") {
                    updateProgress(90);
                    renderCallCenter();
                    updateProgress(100);
                }

                // If on Sales Dashboard, re-render it to update Hot Leads (which now use CC data)
                if (currentDashboard === "salesvisa" && window.globalSalesData) {
                    console.log("🔄 Updating Sales Dashboard with CC data...");
                    renderSalesVisa(window.globalSalesData);
                }
            } catch (err) {
                console.error("Call Center API Error:", err);
                if (grid) {
                    grid.innerHTML = `
                        <div class="card" style="grid-column:1/-1; text-align:center; padding:40px">
                            <div style="font-size:24px; margin-bottom:20px; color:var(--bad)">❌ Connection Failed</div>
                            <div style="color:var(--bad); font-weight:800; margin-bottom:20px">${err.message}</div>
                            <button class="btn" style="margin-top:30px" onclick="loadCallCenterData()">Retry Connection</button>
                        </div>
                    `;
                }
            } finally {
                isCCLoading = false;
                callCenterPromise = null;
            }
        }

        // Load Sales & Visa Dashboard Data
        async function loadSalesVisaData() {
            const grid = $('gridSalesVisa');

            if (!grid) {
                console.warn('Sales & Visa grid not found');
                return;
            }

            grid.innerHTML = `
                <div class="card" style="grid-column:1/-1; text-align:center; padding:40px">
                    <div style="font-size:24px; margin-bottom:20px">🔄 Loading Sales & Visa Data...</div>
                    <div style="color:var(--muted2)">Fetching from Google Sheets</div>
                </div>
            `;

            try {
                const response = await fetch(SALES_VISA_API);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const json = await response.json();
                console.log('📊 Sales & Visa API Response:', json);


                // Extract ONLY json.sales array (renderSalesVisa expects the full object)
                let salesArray = [];
                if (json && Array.isArray(json.sales)) {
                    salesArray = json.sales;
                    console.log(`✅ Extracted ${salesArray.length} records from json.sales`);
                } else if (Array.isArray(json)) {
                    salesArray = json;
                    console.log(`✅ Using direct array (${salesArray.length} records)`);
                } else {
                    console.warn('⚠️ Could not find sales array in response');
                }

                // Store ARRAY globally for modals
                window.globalSalesData = salesArray;

                // Pass FULL OBJECT to renderSalesVisa (it expects data.sales)
                renderSalesVisa(json);

            } catch (error) {
                console.error('Sales & Visa API Error:', error);
                grid.innerHTML = `
                    <div class="card" style="grid-column:1/-1; text-align:center; padding:40px">
                        <div style="font-size:24px; margin-bottom:20px; color:var(--bad)">❌ Failed to Load</div>
                        <div style="color:var(--bad); font-weight:800; margin-bottom:20px">${error.message}</div>
                        <button class="btn" style="margin-top:20px" onclick="dashboardCache.salesvisa.loaded=false; switchDashboard('salesvisa')">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        // --- SALES & VISA HELPERS ---

        function calcSalesMetrics(data) {
            let stats = {
                hot: 0,
                active: 0,
                completed: 0,
                lost: 0,
                lacked: 0,
                reps: {},
                stages: {
                    "Offer Pending": [],
                    "GTE Review": [],
                    "COE Request": [],
                    "Visa Lodged": []
                },
                grantedList: [] // Store details of granted visas
            };

            data.forEach(d => {
                // Normalize keys (Defensive)
                // MAPPED TO USER SCREENSHOT (Step 2219)
                const hotDate = d.Hot_Date || d["Hot Date"] || d.Date || "";
                const salesStart = d.Sales_Start_Date || d["Sales Start Date"] || d["Sales Assigned Date"] || "";
                const visaOutcome = (d.Visa_Outcome || d["Visa Outcome"] || d.Outcome || "").trim();
                const stage = (d.Current_Stage || d["Current Stage"] || "").trim();
                const initialStage = (d.Stage || d["Stage"] || "").trim(); // Column H: "Hot"
                const rep = (d.Sales_Rep || d["Sales Rep"] || d["Sales Rep "] || d.Rep_Name || "Unknown").trim();

                // Normalize Outcome values
                let normOutcome = visaOutcome;
                if (normOutcome === "In Process") normOutcome = "Pending";

                // 1. Presales Hot (Stage = Hot AND Date exists)
                if (initialStage === "Hot" && hotDate) stats.hot++;

                // 2. Count Active (In Process)
                const isCompletedStage = ["Completed", "Lost", "Reverted", "Visa Granted"].includes(stage);

                // Strict "In Process" Check
                // Must be pending outcome AND not terminal stage AND not reverted
                const outcome = (d["Visa Outcome"] || d.Outcome || d.Status || "").trim();
                const reverted = (d["Reverted to Presales"] || "").trim();
                const isPending = outcome === "Pending" || outcome === "" || outcome === "In Process";
                const isTerminalOutcome = ["Approved", "Rejected", "Visa Granted", "Lost", "Withdrawn", "Declined", "Reverted"].includes(outcome);

                let isActive = false;
                if (isPending && !isCompletedStage && !isTerminalOutcome && reverted !== "Yes" && stage !== "Reverted") {
                    isActive = true;
                    stats.active++;
                }

                // 3. Completed (Granted)
                if (["Approved", "Visa Granted"].includes(visaOutcome)) {
                    stats.completed++;
                    // Push to granted list for display
                    stats.grantedList.push({
                        name: d["Student Name"] || "Unknown Client",
                        date: d["Completed Date"] || "",
                        rep: rep
                    });
                } else if (["Rejected", "Declined"].includes(visaOutcome)) {
                    // Only increment completed count for rejected too, separate from granted list
                    stats.completed++;
                }

                // 4. Lost
                if (visaOutcome === "Lost" || stage === "Lost") {
                    stats.lost++;
                }

                // 5. Lacked (Critical)
                // Hot_Date not blank AND Sales_Start_Date blank
                if (hotDate && !salesStart) {
                    stats.lacked++;
                }

                // 5. Rep Stats
                if (!stats.reps[rep]) stats.reps[rep] = { name: rep, active: 0, completed: 0, approved: 0, rejected: 0 };
                if (isActive) stats.reps[rep].active++;
                // "Completed" for Rep might specific to approved/rejected or just finished? User said "Completed this month"
                if (["Approved", "Rejected", "Visa Granted"].includes(visaOutcome)) stats.reps[rep].completed++;
                if (["Approved", "Visa Granted"].includes(visaOutcome)) stats.reps[rep].approved++;
                if (visaOutcome === "Rejected") stats.reps[rep].rejected++;

                // 6. Stages (Only Active items?)
                // User said "Show count in each stage". Usually implies active pipeline.
                if (isActive) {
                    // Match stage bucket
                    // Fuzzy match? "Offer Pending" vs "Offer"
                    if (stage.includes("Offer")) stats.stages["Offer Pending"].push(d);
                    else if (stage.includes("GTE")) stats.stages["GTE Review"].push(d);
                    else if (stage.includes("COE")) stats.stages["COE Request"].push(d);
                    else if (stage.includes("Lodged") || stage.includes("Visa Application")) stats.stages["Visa Lodged"].push(d);
                }
            });

            return stats;
        }

        function calculateAging(dateStr) {
            if (!dateStr) return 0;
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return 0;
            const diff = new Date() - d;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function renderSalesVisa(data) {
            const grid = $('gridSalesVisa');
            if (grid) grid.style.display = "grid"; // Reset to grid if needed, or remove override
            // REMOVED: grid.style.gridTemplateColumns = "repeat(5, 1fr)";
            grid.innerHTML = ""; // Clear

            // 1. Date Ranges (Current vs Previous Month)
            const { start, end } = getRangeDates();
            const prevStart = new Date(start); prevStart.setMonth(prevStart.getMonth() - 1);
            const prevEnd = new Date(end); prevEnd.setMonth(prevEnd.getMonth() - 1);

            // 2. Filter Data
            const salesRaw = data.sales || [];
            globalSalesData = salesRaw; // Store for modal access

            const filterByDate = (arr, s, e) => arr.filter(d => {
                // Determine relevant date column for filtering
                // Priority: "Stage Start Date" (Col O) -> "Sales Assigned Date" (Col K) -> "Date" (Col A)
                let dateCol = d["Stage Start Date"] || d["Sales Assigned Date"] || d.Date || d.Hot_Date;

                let dt = new Date(dateCol);
                if (isNaN(dt.getTime())) dt = parseDateAny(dateCol);
                return dt && dt >= s && dt <= e;
            });

            const currentData = filterByDate(salesRaw, start, end);
            const prevData = filterByDate(salesRaw, prevStart, prevEnd);

            // 3. Calculate Metrics
            const cur = calcSalesMetrics(currentData);
            const prev = calcSalesMetrics(prevData);

            // BALANCE SHEET LOGIC: "In Process" should be ALL pending files (regardless of period)
            const totalStats = calcSalesMetrics(salesRaw);

            // --- FIX: Override Presales Hot with Call Center Data (Step 2294) ---
            if (globalCCData) {
                const ccFiltered = globalCCData.filter(d => {
                    let dt = new Date(d.Date);
                    if (isNaN(dt.getTime())) dt = parseDateAny(d.Date);
                    return dt && dt >= start && dt <= end;
                });
                cur.hot = ccFiltered.filter(d => (d.Stage || "").trim() === "Hot").length;
            }

            // 4. Render Layout (CRM Pipeline Style)
            // Top Row: KPIs (Wrapped in Flex Container for 5-column layout)
            grid.insertAdjacentHTML("beforeend", `
                <div style="grid-column:1/-1; display:flex; gap:15px; flex-wrap:wrap; margin-bottom:10px">
                    <!-- Presales Hot (P&L - In Period) -->
                    <div class="card kpi clickable" style="flex:1; min-width:140px; background:rgba(254,187,46,0.1); border-color:rgba(254,187,46,0.3)" onclick="openModalHelper('hot')">
                        <div class="kpi-icon" style="color:#FEBB2E">🔥 Presales Hot</div>
                        <div class="kpi-value" style="color:#FEBB2E">${cur.hot}</div>
                        <div class="kpi-sub">Leads in Period</div>
                    </div>
                    
                    <!-- Active (In Process) - BALANCE SHEET (All Time) -->
                    <div class="card kpi clickable" style="flex:1; min-width:140px; background:rgba(34,211,238,0.1); border-color:rgba(34,211,238,0.3)" onclick="openModalHelper('active')">
                        <div class="kpi-icon" style="color:#22D3EE">⏳ In Process</div>
                        <div class="kpi-value" style="color:#22D3EE">${totalStats.active}</div>
                        <div class="kpi-sub">Total Active Files</div>
                    </div>
                    
                    <!-- Completed -->
                    <div class="card kpi clickable" style="flex:1; min-width:140px; background:rgba(57,255,136,0.1); border-color:rgba(57,255,136,0.3)" onclick="openModalHelper('completed')">
                        <div class="kpi-icon" style="color:#39FF88">✅ Completed</div>
                        <div class="kpi-value" style="color:#39FF88">${cur.completed}</div>
                        <div class="kpi-sub">Approved/Rejected</div>
                    </div>
                    
                    <!-- Lost -->
                     <div class="card kpi clickable" style="flex:1; min-width:140px; background:rgba(255,99,71,0.1); border-color:rgba(255,99,71,0.3)" onclick="openModalHelper('lost')">
                        <div class="kpi-icon" style="color:#FF6347">❌ Lost</div>
                        <div class="kpi-value" style="color:#FF6347">${cur.lost}</div>
                        <div class="kpi-sub">Withdrawn/Dropped</div>
                    </div>
                    
                    <!-- Lacked (CRITICAL) -->
                    <div class="card kpi clickable" style="flex:1; min-width:140px; background:rgba(255,59,87,0.1); border-color:rgba(255,59,87,0.3)" onclick="openModalHelper('lacked')">
                        <div class="kpi-icon" style="color:#FF3B57">🚨 Lacked / Dropped</div>
                        <div class="kpi-value" style="color:#FF3B57">${cur.lacked}</div>
                        <div class="kpi-sub">Hot but No Sales Start</div>
                    </div>
                </div>
            `);

            // 5. Render Rep Overview (Anusha/Kumkum)
            const reps = ["Anusha", "Kumkum"];
            let repHTML = `<div class="card" style="grid-column:span 4; display:flex; flex-direction:column; gap:15px">`;
            repHTML += `<div style="font-size:16px; font-weight:700; margin-bottom:5px">Sales Rep Overview</div>`;
            repHTML += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:15px">`; // Grid for 2 cards

            reps.forEach(name => {
                // Find stats (fuzzy match key)
                const findKey = (obj) => Object.keys(obj).find(k => k.toLowerCase().includes(name.toLowerCase())) || name;

                // Rep Period-Specific Stats (P&L)
                const kCur = findKey(cur.reps);
                const kPrev = findKey(prev.reps);
                const rCur = cur.reps[kCur] || { active: 0, completed: 0, approved: 0, rejected: 0 };
                const rPrev = prev.reps[kPrev] || { active: 0, completed: 0, approved: 0, rejected: 0 };

                // Rep All-Time Stats (Balance Sheet)
                const kTotal = findKey(totalStats.reps);
                const rTotal = totalStats.reps[kTotal] || { active: 0 };

                // Diff (P&L only)
                // Active Diff is tricky because we compare Snapshot vs Snapshot? 
                // We'll hide Active Diff for now as it's confusing (Total Active vs Period Active?). User asked for Full Active.
                const diffCompleted = rCur.completed - rPrev.completed;
                const diffApp = rCur.approved - rPrev.approved;
                const diffRej = rCur.rejected - rPrev.rejected;

                const fmtDiff = (n) => n > 0 ? `+${n}` : (n < 0 ? `${n}` : "0");
                const colorDiff = (n) => n > 0 ? "var(--good)" : (n < 0 ? "var(--bad)" : "var(--muted2)");

                repHTML += `
                    <div class="clickable" style="background:rgba(255,255,255,0.03); border-radius:12px; padding:15px; border:1px solid var(--stroke2); cursor:pointer; transition:all 0.2s" onclick="openModalHelper('rep', '${name}')">
                        <div style="font-weight:700; margin-bottom:12px; font-size:15px">${name}</div>
                        <!-- Active (All Time) -->
                        <div class="row" style="margin-bottom:10px">
                            <div style="font-size:26px; color:#3b82f6; font-weight:700">${rTotal.active}</div>
                            <div style="text-align:right">
                                <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:0.5px">Total Active</div>
                                <div style="font-size:12px; color:var(--muted2); font-weight:400">Files Handling</div>
                            </div>
                        </div>
                         <!-- Completed (In Period) -->
                         <div class="row" style="margin-bottom:12px; padding-bottom:12px; border-bottom:1px solid var(--stroke)">
                            <div style="font-size:26px; color:#22c55e; font-weight:700">${rCur.completed}</div>
                            <div style="text-align:right">
                                <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:0.5px">Completed</div>
                                <div style="font-size:12px; color:${colorDiff(diffCompleted)}; font-weight:600">${fmtDiff(diffCompleted)} <span style="color:var(--muted2); font-weight:400">vs Prev Period</span></div>
                            </div>
                        </div>
                        <!-- Visas (In Period) -->
                         <div class="row" style="font-size:12px">
                            <div style="color:var(--text)">Visa Granted: <span style="color:var(--good); font-weight:700">${rCur.approved}</span> <span style="opacity:0.5; font-size:11px">(${fmtDiff(diffApp)})</span></div>
                        </div>
                        <div class="row" style="font-size:12px; margin-top:4px">
                            <div style="color:var(--text)">Visa Rejected: <span style="color:var(--bad); font-weight:700">${rCur.rejected}</span> <span style="opacity:0.5; font-size:11px">(${fmtDiff(diffRej)})</span></div>
                        </div>
                    </div>
                `;
            });
            repHTML += `</div></div>`; // End Grid, End Card

            grid.insertAdjacentHTML("beforeend", repHTML);

            // 6. Stage Progress Table (Span 2)
            const stageTargets = {
                "Offer Pending": 3,
                "GTE Review": 5,
                "COE Request": 4,
                "Visa Lodged": 7
            };

            const getColorForStage = (s) => {
                if (s.includes("Offer")) return "#facc15";
                if (s.includes("GTE")) return "#3b82f6";
                if (s.includes("COE")) return "#8b5cf6";
                if (s.includes("Visa")) return "#ec4899";
                return "#94a3b8";
            };

            let stageHTML = `
                <div class="card" style="grid-column:span 4; padding:0; overflow:hidden"> <!-- Kept span 4 to fill row if needed, or maybe span 2 if we want Visas next to it? Screenshot shows Stage Progress spanning wide. Let's try Span 3 and Visas Span 1? No, Grid is 4 cols (implied by previous "span 4" being full width?). 
                Actually, Rep Breakdown (span 2) + Stage Progress (span 2) would be a good row. 
                Let's make Stage Progress Span 2. -->
                <div class="card" style="grid-column:span 2; padding:0; overflow:hidden">
                    <div style="padding:15px; border-bottom:1px solid var(--stroke); font-weight:700; background:rgba(255,255,255,0.02)">
                        Stage Progress & Aging
                    </div>
                    <div style="display:grid; grid-template-columns: 1.5fr 0.8fr 0.8fr 1fr; padding:10px 15px; font-size:11px; color:var(--muted2); border-bottom:1px solid var(--stroke)">
                        <div>Status</div>
                        <div>Files</div>
                        <div>Target</div>
                        <div>Overdue</div>
                    </div>
            `;

            Object.keys(stageTargets).forEach(stage => {
                const items = totalStats.stages[stage] || [];
                const target = stageTargets[stage];

                let overdueCount = 0;
                items.forEach(d => {
                    const dateVal = d["Stage Start Date"] || d.Date || "";
                    const age = calculateAging(dateVal);
                    if (age > target) overdueCount++;
                });

                const isOverdue = overdueCount > 0;

                stageHTML += `
                    <div style="display:grid; grid-template-columns: 1.5fr 0.8fr 0.8fr 1fr; padding:10px 15px; border-bottom:1px solid var(--stroke); align-items:center; font-size:12px; ${isOverdue ? 'background:rgba(255,59,87,0.05);' : ''}; cursor:pointer" onclick="openModalHelper('stage', '${stage}')">
                        <div style="font-weight:600; color:var(--text); display:flex; align-items:center">
                            <span style="display:inline-block; width:6px; height:6px; background:${getColorForStage(stage)}; border-radius:50%; margin-right:6px"></span>
                            ${stage}
                        </div>
                        <div style="font-weight:700">${items.length}</div>
                        <div style="color:var(--muted2)">< ${target}d</div>
                        <div style="color:${isOverdue ? '#FF3B57' : 'var(--muted2)'}; font-weight:${isOverdue ? '700' : '400'}; display:flex; align-items:center">
                            ${overdueCount} ${isOverdue ? '⚠️' : ''}
                        </div>
                    </div>
                `;
            });
            stageHTML += `</div>`; // End Stage Card

            grid.insertAdjacentHTML("beforeend", stageHTML);


            // 7. Visas Granted & Success Rate (Span 4 total -> Row 3?)
            // Let's put Visas Granted (Span 2) and Success Rate (Span 2) in the next row?
            // Or if Rep (Span 2) + Stage (Span 2) = Row 2.
            // Then Visas (Span 2) + Success (Span 2) = Row 3.

            // Visas Granted Card (Span 2)
            const approvedCount = cur.grantedList.length;
            const rejectedCount = cur.completed - approvedCount;
            const totalDecided = approvedCount + rejectedCount;
            const successRate = totalDecided > 0 ? Math.round((approvedCount / totalDecided) * 100) : 0;

            grid.insertAdjacentHTML("beforeend", `
                <div class="card" style="grid-column:span 2; display:flex; flex-direction:column; padding:0; overflow:hidden">
                    <div style="padding:15px; border-bottom:1px solid var(--stroke); display:flex; justify-content:space-between; align-items:center; background:rgba(34,197,94,0.05)">
                        <div>
                            <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:0.5px">Visas Granted (In Period)</div>
                            <div style="font-size:24px; color:var(--good); font-weight:700; line-height:1.1">${approvedCount}</div>
                        </div>
                        <div style="font-size:20px; opacity:0.2">🏆</div>
                    </div>
                    <div style="flex:1; overflow-y:auto; max-height:200px; padding:0">
                        ${cur.grantedList.length > 0 ? cur.grantedList.map(g => `
                            <div style="padding:10px 15px; border-bottom:1px solid var(--stroke); display:flex; justify-content:space-between; align-items:center; font-size:12px">
                                <div>
                                    <div style="font-weight:600; color:var(--text)">${g.name}</div>
                                    <div style="font-size:10px; color:var(--muted2)">👤 ${g.rep || "Unk"}</div>
                                </div>
                                <div style="font-size:11px; color:var(--muted2); background:rgba(255,255,255,0.05); padding:2px 6px; border-radius:4px">${new Date(g.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}</div>
                            </div>
                        `).join("") : `<div style="padding:20px; text-align:center; color:var(--muted2); font-size:11px">No visas this period</div>`}
                    </div>
                </div>

                <!-- Success Rate (Span 2) -->
                 <div class="card" style="grid-column:span 2; display:flex; flex-direction:column; padding:20px; justify-content:center">
                    <div style="font-size:12px; color:var(--muted2); text-transform:uppercase; letter-spacing:0.5px">Visa Success Rate</div>
                    <div style="display:flex; align-items:baseline; gap:10px; margin-top:5px">
                        <div style="font-size:42px; color:var(--text); font-weight:700; line-height:1">${successRate}%</div>
                        <div style="font-size:12px; color:var(--muted2)">of decisions</div>
                    </div>
                    <div style="margin-top:20px; display:flex; gap:10px">
                         <div style="flex:1; background:rgba(34,197,94,0.1); padding:10px; border-radius:8px; text-align:center">
                            <div style="font-size:16px; font-weight:700; color:var(--good)">${approvedCount}</div>
                            <div style="font-size:10px; opacity:0.7">Granted</div>
                         </div>
                         <div style="flex:1; background:rgba(239,68,68,0.1); padding:10px; border-radius:8px; text-align:center">
                            <div style="font-size:16px; font-weight:700; color:var(--bad)">${rejectedCount}</div>
                            <div style="font-size:10px; opacity:0.7">Rejected</div>
                         </div>
                    </div>
                 </div>
            `);

            // 8. Trend Chart (Full Width)
            grid.insertAdjacentHTML("beforeend", `
                <div class="card" style="grid-column:1/-1; padding:20px; margin-bottom:40px">
                    <div style="font-weight:700; margin-bottom:15px; font-size:16px;">Sales Velocity (New Hot Leads vs Visas Granted)</div>
                    <div style="height:300px; width:100%"><canvas id="salesTrendChart"></canvas></div>
                </div>
            `);

            // Render the Chart
            setTimeout(() => renderSalesTrendChart(salesRaw), 100);

        }

        // --- Sales Trend Chart Helper ---
        let salesChartInstance = null;

        function renderSalesTrendChart(data) {
            const ctx = document.getElementById("salesTrendChart");
            if (!ctx) return;

            if (salesChartInstance) {
                salesChartInstance.destroy();
            }

            // Aggregate Data by Month
            const months = {}; // "2025-10": { hot: 0, granted: 0 }

            // Helper to get YYYY-MM key safely
            const getKey = (dStr) => {
                if (!dStr) return null;
                let dt = new Date(dStr);
                if (isNaN(dt.getTime())) dt = parseDateAny(dStr);
                if (!dt || isNaN(dt.getTime())) return null;
                return dt.toISOString().slice(0, 7);
            };

            data.forEach(d => {
                // Hot Leads (based on Stage Start Date or Date)
                const hotDateStr = d["Stage Start Date"] || d.Date;
                const kHot = getKey(hotDateStr);
                if (kHot) {
                    if (!months[kHot]) months[kHot] = { hot: 0, granted: 0 };
                    months[kHot].hot++;
                }

                // Visa Granted
                // Logic: Outcome = "Approved" or "Visa Granted"
                // And use "Completed Date" (Col R)
                const doneDateStr = d["Completed Date"];
                const outcome = (d["Visa Outcome"] || "").trim();
                const isGranted = outcome === "Approved" || outcome === "Visa Granted";

                if (doneDateStr && isGranted) {
                    const kDone = getKey(doneDateStr);
                    if (kDone) {
                        if (!months[kDone]) months[kDone] = { hot: 0, granted: 0 };
                        months[kDone].granted++;
                    }
                }
            });

            // Sort Months
            const sortedKeys = Object.keys(months).sort();
            const labels = sortedKeys.map(k => {
                const [y, m] = k.split("-");
                return new Date(y, m - 1, 1).toLocaleString('default', { month: 'short', year: 'numeric' });
            });

            const dataHot = sortedKeys.map(k => months[k].hot);
            const dataGranted = sortedKeys.map(k => months[k].granted);

            // Chart.js - Responsive configuration
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth < 768;
            const isTablet = screenWidth >= 768 && screenWidth < 1024;

            // Adjust tick limits based on screen size
            const tickLimit = isMobile ? 6 : (isTablet ? 8 : 12);
            const fontSize = isMobile ? 9 : (isTablet ? 10 : 11);
            const rotation = isMobile ? 45 : 0;

            salesChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'New Leads (Enquiry)',
                            data: dataHot,
                            borderColor: '#FEBB2E', // Orange/Yellow
                            backgroundColor: 'rgba(254, 187, 46, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: isMobile ? 3 : 4,
                            pointBackgroundColor: '#FEBB2E'
                        },
                        {
                            label: 'Visas Granted',
                            data: dataGranted,
                            borderColor: '#39FF88', // Green
                            backgroundColor: 'rgba(57, 255, 136, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: isMobile ? 3 : 4,
                            pointBackgroundColor: '#39FF88'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            bottom: isMobile ? 10 : 5,
                            left: 5,
                            right: 5
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#94a3b8',
                                font: { family: 'Inter', size: isMobile ? 10 : 12 },
                                padding: isMobile ? 8 : 10
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#e2e8f0',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: isMobile ? 8 : 12
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: {
                                color: '#64748b',
                                font: { family: 'Inter', size: fontSize }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                color: '#e2e8f0',
                                font: { family: 'Inter', size: fontSize, weight: '500' },
                                maxRotation: isMobile ? 45 : 45,
                                minRotation: 0,
                                autoSkip: true,
                                maxTicksLimit: tickLimit,
                                padding: 5
                            }
                        }
                    }
                }
            });
        }

        function renderCallCenter() {
            if (!globalCCData) return;
            const grid = $("gridCallCenter");
            grid.innerHTML = ""; // Clear existing content

            // --- Sticky Tabs ---
            grid.insertAdjacentHTML("beforeend", `
                <div class="card" style="grid-column:1/-1; padding:0; background:transparent; border:none; overflow:visible">
                    <div class="tabs">
                        <button class="tab ${currentCCTab === 'summary' ? 'active' : ''}" onclick="switchCallCenterTab('summary', this)">Summary</button>
                        <button class="tab ${currentCCTab === 'analytics' ? 'active' : ''}" onclick="switchCallCenterTab('analytics', this)">Analytics</button>
                    </div>
                </div>
            `);

            // Container for Views
            grid.insertAdjacentHTML("beforeend", `
                <div id="ccViewSummary" style="display:${currentCCTab === 'summary' ? 'contents' : 'none'}"></div>
                <div id="ccAnalyticsContainer" style="display:${currentCCTab === 'analytics' ? 'grid' : 'none'}; grid-column:1/-1; grid-template-columns:repeat(4, 1fr); gap:16px"></div>
            `);

            if (currentCCTab === 'analytics') {
                renderAnalytics();
                return;
            }

            // --- SUMMARY VIEW LOGIC (Existing) ---
            // We append to grid, but we want it inside ccViewSummary? 
            // Actually, "display:contents" allows children to be grid items of parent #gridCallCenter.
            // But if we append to grid, it will be siblings of ccViewSummary.
            // Let's create a temporary holder or just append to grid IF summary is active.

            // BETTER APPROACH:
            // The Original logic appended directly to `grid`.
            // Now `grid` has Tabs + View Containers.
            // If I append to `grid`, it works for "contents".
            // logic below appends to `grid`. So if I just let it run, it appends to grid.
            // BUT, if I switch tabs, I clear grid effectively via switchCallCenterTab -> renderCallCenter.
            // So I just need to guard the logic below.

            // 1. Filter Data by Date
            const { start, end } = getRangeDates();

            const filtered = globalCCData.filter(d => {
                let dt = new Date(d.Date);
                if (isNaN(dt.getTime())) dt = parseDateAny(d.Date);
                if (!dt || isNaN(dt.getTime())) return false;
                return dt >= start && dt <= end;
            });

            // 2. Compute KPIs
            const totalCalls = filtered.length;
            const hotLeads = filtered.filter(d => (d.Stage || "").trim() === "Hot").length;

            // "Leakage" = Any lead that is still New/Uncalled (regardless of time)
            // Wait, leakage logic in original seems to check current status of FILTERED leads (in period).
            // Usually leakage is a "State" regardless of date, but let's stick to original.
            const leakage = filtered.filter(d => {
                const s = (d.Status || "").toLowerCase();
                return s === "new" || s === "uncalled" || s === "pending" || s === "";
            }).length;

            const reverted = 0; // Placeholder as per original

            // 3. Render Widgets (Summary)
            // We use a helper to inject into the "display:contents" view if possible, OR just grid.
            // Since we cleared grid, and added tabs/containers.
            // If Summary is active, we can append to grid (as siblings).
            // If Analytics, we return early above.

            // 3. Render Widgets (Summary)
            // Row 1: KPIs
            grid.insertAdjacentHTML("beforeend", `
              <div class="card kpi clickable" onclick="openModalHelper('cc_leakage')" style="border-color:rgba(255,59,87,0.3); cursor:pointer">
                <div class="label" style="color:#FF3B57">📞 Leakage Alert</div>
                <div class="value" style="color:#FF3B57">${leakage} Leads</div>
                <div class="subtle">Leads Uncalled</div>
              </div>
              <div class="card kpi clickable" onclick="openModalHelper('cc_total')" style="cursor:pointer">
                <div class="label">Total Calls</div>
                <div class="value">${totalCalls.toLocaleString()}</div>
                <div class="subtle">In selected period</div>
              </div>
               <div class="card kpi clickable" onclick="openModalHelper('cc_reverted')" style="cursor:pointer">
                <div class="label">Reverted Clients</div>
                <div class="value">${reverted}</div>
                <div class="subtle">Old leads active again</div>
              </div>
               <div class="card kpi clickable" onclick="openModalHelper('cc_hot')" style="border-color:rgba(254,187,46,0.3); cursor:pointer">
                <div class="label" style="color:#FEBB2E">Total Hot Leads</div>
                <div class="value" style="color:#FEBB2E">${hotLeads}</div>
                <div class="subtle">Stage = Hot</div>
              </div>
            `);

            // Row 2: Charts (Status Breakdown & Leaderboard)
            grid.insertAdjacentHTML("beforeend", `
                <div class="card chartCard" style="grid-column: span 7">
                   <div class="section-title">Status Breakdown by Rep</div>
                   <div class="flex-chart"><canvas id="ccStatusChart"></canvas></div>
                </div>
                <div class="card tableCard" style="grid-column: span 5">
                   <div class="section-title">Top Call Reps</div>
                    <div id="ccLeaderboard" style="margin-top:10px; flex:1; overflow:auto"></div>
                </div>
            `);

            // Row 3: Performance Summary
            grid.insertAdjacentHTML("beforeend", `
                <div class="card bottomFull" style="height:auto; min-height:200px; display:block; grid-column:1/-1">
                    <div class="section-title">Performance Summary</div>
                    <div class="table-container">
                        <table style="width:100%">
                            <thead>
                                <tr>
                                    <th>Rep Name</th>
                                    <th>Total Calls</th>
                                    <th>Avg/Day</th>
                                    <th>🔥 Hot</th>
                                    <th>✅ Warm</th>
                                    <th>❄️ Cold</th>
                                    <th>❌ Lost</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="ccSummaryBody"></tbody>
                        </table>
                    </div>
                </div>
            `);

            // --- Logic for Charts/Tables (Summary) ---

            // Group by Rep
            const reps = {};
            filtered.forEach(d => {
                const r = d.Rep || "Unknown";
                if (!reps[r]) reps[r] = { total: 0, hot: 0, warm: 0, cold: 0, lost: 0, ineligible: 0 };
                reps[r].total++;
                const s = (d.Stage || "").trim();
                if (s === "Hot") reps[r].hot++;
                else if (s === "Warm") reps[r].warm++;
                else if (s === "Cold") reps[r].cold++;
                else if (s === "Lost") reps[r].lost++;
                else reps[r].ineligible++;
            });

            // 4. Render Chart
            const repLabels = Object.keys(reps);
            const dataHot = repLabels.map(r => reps[r].hot);
            const dataWarm = repLabels.map(r => reps[r].warm);
            const dataCold = repLabels.map(r => reps[r].cold);
            const dataLost = repLabels.map(r => reps[r].lost);

            if (charts.ccStatus) charts.ccStatus.destroy();
            const ctx = document.getElementById("ccStatusChart").getContext("2d");
            charts.ccStatus = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: repLabels,
                    datasets: [
                        { label: 'Hot', data: dataHot, backgroundColor: '#FEBB2E' },
                        { label: 'Warm', data: dataWarm, backgroundColor: '#28C840' },
                        { label: 'Cold', data: dataCold, backgroundColor: '#38BDF8' },
                        { label: 'Lost', data: dataLost, backgroundColor: '#FF5F57' },
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true, grid: { display: false } }, y: { stacked: true, grid: { color: "rgba(255,255,255,0.05)" } } },
                    plugins: { legend: { position: 'right', labels: { color: '#94A3B8' } } },
                    onClick: (e, activeEls) => {
                        if (!activeEls || activeEls.length === 0) return;
                        const { datasetIndex, index } = activeEls[0];
                        const label = repLabels[index];
                        // Map dataset index to status string
                        // 0=Hot, 1=Warm, 2=Cold, 3=Lost
                        const stageMap = ["Hot", "Warm", "Cold", "Lost"];
                        const stage = stageMap[datasetIndex];
                        if (label && stage) {
                            openModalHelper('cc_rep_breakdown', label, stage);
                        }
                    }
                }
            });

            // 5. Render Leaderboard & Table
            const sortedReps = repLabels.map(r => ({ name: r, ...reps[r] })).sort((a, b) => b.total - a.total);

            // Leaderboard (Top 3)
            const lbHTML = sortedReps.slice(0, 3).map((r, i) => `
                <div style="display:flex; align-items:center; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); margin-bottom:8px; border-radius:10px; border:1px solid var(--stroke); cursor:pointer" onclick="openModalHelper('cc_rep_total', '${r.name}')">
                   <div style="display:flex; align-items:center; gap:12px">
                      <span style="font-size:20px">${i === 0 ? '🥇' : i === 1 ? '🥈' : '🥉'}</span>
                      <span style="font-weight:700">${r.name}</span>
                   </div>
                   <div style="font-weight:900; font-size:16px">${r.total}</div>
                </div>
            `).join("");
            $("ccLeaderboard").innerHTML = lbHTML;

            // Performance Table
            const dayDiff = Math.max(1, (end - start) / (1000 * 60 * 60 * 24));

            $("ccSummaryBody").innerHTML = sortedReps.map(r => `
                <tr style="cursor:pointer" onclick="openModalHelper('cc_rep_total', '${r.name}')">
                    <td style="font-weight:700">${r.name}</td>
                    <td>${r.total}</td>
                    <td>${(r.total / dayDiff).toFixed(1)}</td>
                    <td style="color:#FEBB2E">${r.hot}</td>
                    <td style="color:#28C840">${r.warm}</td>
                    <td style="color:#38BDF8">${r.cold}</td>
                    <td style="color:#FF5F57">${r.lost}</td>
                    <td><button class="btn" style="padding:4px 10px; font-size:11px" onclick="event.stopPropagation(); openModalHelper('cc_rep_total', '${r.name}')">View</button></td>
                </tr>
             `).join("");
        }

        // --- Modal Logic ---
        function openDetails(type, filterSource = null) {
            if (!currentData) return;
            let title = "", rows = [], keys = [];

            if (type === "spend") {
                title = "Expense Details";
                rows = currentData.filteredSpend;
                if (filterSource) {
                    rows = rows.filter(r => normalizeSource(r.Source) === filterSource);
                    title += ` - ${filterSource}`;
                }
                if (rows.length > 0) keys = Object.keys(rows[0]);
                else keys = ["Month", "Source", "Amount Spent (NPR)"];
            } else if (type === "leads") {
                title = "Leads Details";
                rows = currentData.filteredLeads;
                if (filterSource) {
                    rows = rows.filter(r => normalizeSource(r.Source) === filterSource);
                    title += ` - ${filterSource}`;
                }
                if (rows.length > 0) keys = Object.keys(rows[0]);
                else keys = ["Date", "Client ID", "Student Name", "Phone Number", "Source", "Status", "Campaign Name"];
            }

            $("modalTitle").textContent = title;

            // Headers
            const head = $("modalHead");
            head.innerHTML = `<tr>${keys.map(k => `<th>${k}</th>`).join("")}</tr>`;

            // Body
            const body = $("modalBody");
            body.innerHTML = rows.map(r => `<tr>${keys.map(k => `<td>${r[k] || ""}</td>`).join("")}</tr>`).join("");

            $("modalOverlay").classList.add("open");
        }

        function closeModal() {
            $("modalOverlay").classList.remove("open");
        }

        /**
         * Show files in modal with rich card visual view
         * @param {Array} files - Array of file objects
         * @param {String} title - Modal title
         */
        /**
         * Show files in modal with table view
         * @param {Array} rows - Array of data objects
         * @param {String} title - Modal title
         */
        function showModal(rows, title) {
            $("modalTitle").textContent = title + ` (${rows.length} records)`;

            const body = $("modalBody");
            const modalBodyDiv = body.parentElement;

            // Generate Table Structure if not present or if overwritten by previous card view
            if (!modalBodyDiv.querySelector('table')) {
                modalBodyDiv.innerHTML = `
                    <table>
                        <thead id="modalHead"></thead>
                        <tbody id="modalBody"></tbody>
                    </table>
                `;
            }

            const thead = $("modalHead");
            const tbody = $("modalBody");

            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align:center; padding:20px; color:var(--muted2)">No records found</td></tr>`;
                thead.innerHTML = "";
                $("modalOverlay").classList.add("open");
                return;
            }

            // Determine columns dynamically from the first few rows
            // We want to show specific columns if available
            const allKeys = Object.keys(rows[0]);

            // Priority columns to show first
            const priorityCols = ["Client ID", "Student Name", "Phone Number", "Sales Rep", "Stage", "Visa Outcome", "Country"];

            // Filter keys to prioritise readable columns, then others
            let keys = priorityCols.filter(k => allKeys.includes(k));
            const remainingKeys = allKeys.filter(k => !priorityCols.includes(k) && !k.startsWith("_")); // Exclude internal keys
            keys = [...keys, ...remainingKeys];

            // Render Headers
            thead.innerHTML = `<tr>${keys.map(k => `<th>${k}</th>`).join("")}</tr>`;

            // Render Body
            tbody.innerHTML = rows.map(r => `
                <tr>
                    ${keys.map(k => {
                let val = r[k] || "";
                // Format dates if looks like date
                if (k.includes("Date") && val) {
                    try {
                        const d = new Date(val);
                        if (!isNaN(d.getTime())) val = d.toLocaleDateString();
                    } catch (e) { }
                }
                return `<td>${val}</td>`;
            }).join("")}
                </tr>
            `).join("");

            $("modalOverlay").classList.add("open");
        }

        /* Clicking the overlay also closes */

        // Centralized Active Check Helper
        function isActiveFile(f) {
            const stage = (f["Current Stage"] || f.Stage || "").trim();
            const outcome = (f["Visa Outcome"] || f.Outcome || f.Status || "").trim();
            const reverted = (f["Reverted to Presales"] || "").trim();

            const isCompletedStage = ["Completed", "Lost", "Reverted", "Visa Granted"].includes(stage);
            const isPending = outcome === "Pending" || outcome === "" || outcome === "In Process";
            const isTerminalOutcome = ["Approved", "Rejected", "Visa Granted", "Lost", "Withdrawn", "Declined", "Reverted"].includes(outcome);

            // Explicit Exclusion
            if (stage === "Reverted" || outcome === "Reverted" || reverted === "Yes") return false;

            // Must be pending and not in a terminal stage to be Active
            if (!isPending || isTerminalOutcome || isCompletedStage) return false;

            return true;
        }

        function openModalHelper(type, arg1, arg2) {
            const { start, end } = getRangeDates();

            // Helper to date filter
            const inRange = (d, dateCol) => {
                let dt = new Date(d[dateCol] || d.Date);
                if (isNaN(dt.getTime())) dt = parseDateAny(d[dateCol] || d.Date);
                return dt && dt >= start && dt <= end;
            };

            let data = [];
            let title = "";

            // --- CALL CENTER CASES ---
            if (type === 'cc_leakage') {
                data = globalCCData.filter(d => {
                    if (!inRange(d, 'Date')) return false;
                    const s = (d.Status || "").toLowerCase();
                    return s === "new" || s === "uncalled" || s === "pending" || s === "";
                });
                title = "Leakage Alert (New/Uncalled Leads)";
            } else if (type === 'cc_total') {
                data = globalCCData.filter(d => inRange(d, 'Date'));
                title = "Total Calls (In Period)";
            } else if (type === 'cc_hot') {
                data = globalCCData.filter(d => inRange(d, 'Date') && (d.Stage || "").trim() === "Hot");
                title = "Total Hot Leads (Call Center)";
            } else if (type === 'cc_reverted') {
                // Logic based on "Reverted" flag if available, or Status
                data = globalCCData.filter(d => {
                    if (!inRange(d, 'Date')) return false;
                    const s = (d.Status || "").toLowerCase();
                    return s.includes("revert");
                });
                title = "Reverted Clients";
            } else if (type === 'cc_rep_total') {
                // Arg1 = Rep Name
                data = globalCCData.filter(d => inRange(d, 'Date') && (d.Rep || "Unknown") === arg1);
                title = `${arg1} - Total Calls (In Period)`;
            } else if (type === 'cc_rep_breakdown') {
                // Arg1 = Rep Name, Arg2 = Status (Hot/Warm/Cold/Lost)
                data = globalCCData.filter(d => {
                    if (!inRange(d, 'Date')) return false;
                    if ((d.Rep || "Unknown") !== arg1) return false;
                    const stage = (d.Stage || "").trim();
                    return stage === arg2;
                });
                title = `${arg1} - ${arg2} Leads`;
            } else if (type === 'cc_trend_month') {
                // Arg1 = "YYYY-MM" string
                const targetMonth = arg1; // e.g. "2023-10"
                data = globalCCData.filter(d => {
                    let dt = new Date(d.Date);
                    if (isNaN(dt.getTime())) dt = parseDateAny(d.Date);
                    if (!dt || isNaN(dt.getTime())) return false;

                    const key = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`;
                    const stage = (d.Stage || "").trim();

                    return key === targetMonth && stage === "Hot";
                });
                title = `Hot Leads - ${arg1}`;
            } else if (type === 'cc_source_hot') {
                // Arg1 = Source (e.g. "Facebook")
                const targetSrc = normalizeSource(arg1);
                data = globalCCData.filter(d => {
                    if (!inRange(d, 'Date')) return false;
                    const stage = (d.Stage || "").trim();
                    const src = normalizeSource(d.Source);
                    return stage === "Hot" && src === targetSrc;
                });
                title = `Hot Leads from ${arg1}`;
            } else if (type === 'cc_loss_breakdown') {
                // Arg1 = Loss Reason (e.g. "Not Interested") or "All"
                data = globalCCData.filter(d => {
                    if (!inRange(d, 'Date')) return false;
                    const isLost = (d.Stage === 'Lost') || (d["Visa Outcome"] === "Lost");
                    if (!isLost) return false;

                    if (arg1 === 'All') return true;

                    const reason = d['Loss Reason'] || d.Status || 'Not Specified';
                    return reason === arg1;
                });
                title = arg1 === 'All' ? "All Lost Leads" : `Loss Reason: ${arg1}`;
            }

            // --- SALES / MARKETING CASES ---
            else if (type === 'hot') {
                // Comes from Call Center Data -> Date Filter
                data = globalCCData.filter(d => inRange(d, 'Date') && (d.Stage || "").trim() === "Hot");
                title = "Presales Hot Leads (In Period)";
            } else if (type === 'active') {
                // Balance Sheet (All Time) - No Date Filter
                data = globalSalesData.filter(f => {
                    const stage = (f.Stage || f["Current Stage"] || "").trim();
                    const outcome = (f["Visa Outcome"] || f.Outcome || f.Status || "").trim();
                    const reverted = (f["Reverted to Presales"] || "").trim();

                    const isCompletedStage = ["Completed", "Lost", "Reverted", "Visa Granted"].includes(stage);
                    const isPending = outcome === "Pending" || outcome === "" || outcome === "In Process";

                    const isTerminalOutcome = ["Approved", "Rejected", "Visa Granted", "Lost", "Withdrawn", "Declined", "Reverted"].includes(outcome);

                    // Explicit Exclusion
                    if (stage === "Reverted" || outcome === "Reverted" || reverted === "Yes") return false;

                    // Must be pending and not in a terminal stage to be Active
                    return isPending && !isTerminalOutcome && !isCompletedStage;
                });
                title = "All Active In-Process Files";
                // Display Fix: Prioritize Current Stage in "Stage" column
                data = data.map(d => ({
                    ...d,
                    Stage: d["Current Stage"] || d.Stage || ""
                }));
            }

            showModal(data, title);
        }

        $("modalOverlay").addEventListener("click", (e) => {
            if (e.target.id === "modalOverlay") closeModal();
        });

        init();
        // --- Call Center Tabs Logic ---
        let currentCCTab = 'summary';

        function switchCallCenterTab(tab, el) {
            currentCCTab = tab;
            // Re-render the container to show correct view
            renderCallCenter();
        }

        function renderAnalytics() {
            if (!globalCCData || globalCCData.length === 0) {
                const c = $("ccAnalyticsContainer");
                if (c) c.innerHTML = '<div class="analytics-card full">No data available</div>';
                return;
            }

            const grid = $('ccAnalyticsContainer');
            if (!grid) return;
            grid.innerHTML = '';
            grid.style.display = 'grid';
            grid.style.gridTemplateColumns = 'repeat(4, 1fr)';
            grid.style.gap = '16px';

            // Filter by date range
            const { start, end } = getRangeDates();

            const filtered = globalCCData.filter(d => {
                let dt = new Date(d.Date);
                if (isNaN(dt.getTime())) dt = parseDateAny(d.Date);
                return dt && dt >= start && dt <= end;
            });

            // 1. Loss Reasons Chart
            const lostLeads = filtered.filter(d => (d.Stage === 'Lost') || (d["Visa Outcome"] === "Lost"));
            const lossReasons = {};
            lostLeads.forEach(d => {
                const reason = d['Loss Reason'] || d.Status || 'Not Specified';
                lossReasons[reason] = (lossReasons[reason] || 0) + 1;
            });

            const reasonLabels = Object.keys(lossReasons).length > 0 ? Object.keys(lossReasons) : ['No Lost Leads'];
            const reasonCounts = Object.keys(lossReasons).length > 0 ? Object.values(lossReasons) : [1];

            // 2. Hot Leads by Source
            const hotLeadsFiltered = filtered.filter(d => (d.Stage || "").trim() === 'Hot');
            const hotBySource = {};
            hotLeadsFiltered.forEach(d => {
                const src = normalizeSource(d.Source);
                hotBySource[src] = (hotBySource[src] || 0) + 1;
            });

            const sourceLabels = Object.keys(hotBySource);
            const sourceCounts = Object.values(hotBySource);

            grid.insertAdjacentHTML('beforeend', `
                <div class="analytics-card half">
                    <div class="section-title">❌ Loss Reasons (${lostLeads.length})</div>
                    <div class="compact-chart"><canvas id="lossChart"></canvas></div>
                </div>
                <div class="analytics-card half">
                    <div class="section-title">🔥 Hot Leads by Source</div>
                    <div class="compact-chart"><canvas id="sourceChart"></canvas></div>
                </div>
            `);

            // Check if Chart is loaded
            if (typeof Chart === 'undefined') return;

            // Render Loss Chart
            if (charts.lossChart) charts.lossChart.destroy();
            const ctxLoss = $('lossChart').getContext('2d');
            charts.lossChart = new Chart(ctxLoss, {
                type: 'doughnut',
                data: {
                    labels: reasonLabels,
                    datasets: [{
                        data: reasonCounts,
                        backgroundColor: ['#FF3B57', '#FF6B81', '#FF8A9B', '#FFA9B5', '#FFC8CF', '#FFD4D9']
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#94A3B8', boxWidth: 10, padding: 8, font: { size: 10 } } } },
                    onClick: (e, activeEls) => {
                        if (!activeEls || activeEls.length === 0) return;
                        const { index } = activeEls[0];
                        const reason = reasonLabels[index];
                        // Open modal for specific reason
                        openModalHelper('cc_loss_breakdown', reason);
                    }
                }
            });

            // Render Source Chart
            if (charts.sourceChart) charts.sourceChart.destroy();
            const ctxSource = $('sourceChart').getContext('2d');
            charts.sourceChart = new Chart(ctxSource, {
                type: 'bar',
                data: {
                    labels: sourceLabels,
                    datasets: [{ label: 'Hot Leads', data: sourceCounts, backgroundColor: '#FEBB2E' }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94A3B8' } },
                        y: { grid: { display: false }, ticks: { color: '#94A3B8', font: { size: 11 } } }
                    },
                    plugins: { legend: { display: false } },
                    onClick: (e, activeEls) => {
                        if (!activeEls || activeEls.length === 0) return;
                        const { index } = activeEls[0];
                        const source = sourceLabels[index];
                        // Filter by specific source
                        openModalHelper('cc_source_hot', source);
                    }
                }
            });

            // 3. Historical Trend Chart (Last 6 Months)
            const monthlyData = {};
            const now = new Date();
            const monthLabels = [];

            // Initialize last 6 months
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                monthlyData[key] = { hot: 0, label: d.toLocaleString('default', { month: 'short' }) };
                monthLabels.push(key);
            }

            // Aggregate Data (Global Data, not just filtered range, to show trend)
            globalCCData.forEach(d => {
                let dt = new Date(d.Date);
                if (isNaN(dt.getTime())) dt = parseDateAny(d.Date);
                if (!dt || isNaN(dt.getTime())) return;

                const key = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}`;
                if (monthlyData[key]) {
                    const status = (d.Stage || "").trim();
                    if (status === "Hot") monthlyData[key].hot++;
                }
            });

            const trendLabels = monthLabels.map(k => monthlyData[k].label);
            const trendData = monthLabels.map(k => monthlyData[k].hot);

            grid.insertAdjacentHTML('beforeend', `
                <div class="analytics-card full">
                    <div class="section-title">📈 Hot Leads Trend (Last 6 Months)</div>
                    <div class="compact-chart" style="height:300px"><canvas id="trendChart"></canvas></div>
                </div>
            `);

            if (charts.trendChart) charts.trendChart.destroy();
            const ctxTrend = $('trendChart').getContext('2d');
            charts.trendChart = new Chart(ctxTrend, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Hot Leads',
                        data: trendData,
                        borderColor: '#FEBB2E',
                        backgroundColor: 'rgba(254, 187, 46, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#FEBB2E'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94A3B8' } },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94A3B8' }, beginAtZero: true }
                    },
                    plugins: { legend: { display: false } },
                    onClick: (e, activeEls) => {
                        if (!activeEls || activeEls.length === 0) return;
                        const { index } = activeEls[0];
                        const key = monthLabels[index]; // e.g. "2023-10"
                        openModalHelper('cc_trend_month', key);
                    }
                }
            });
        }



        // --- CEO VIEW LOGIC ---
        async function renderCeoView() {
            const grid = $('gridCeo');
            if (!grid) return;

            try {
                // Check if we need to load any data
                const needsMarketing = !marketingRendered;
                const needsCC = !globalCCData || globalCCData.length === 0;
                const needsSales = !window.globalSalesData || window.globalSalesData.length === 0;
                const needsLoading = needsMarketing || needsCC || needsSales;

                // Only show loading screen if we actually need to fetch data
                if (needsLoading) {
                    grid.innerHTML = `
                        <div class="card" style="grid-column:1/-1; text-align:center; padding:40px">
                            <div style="font-size:24px; margin-bottom:20px">🔄 Loading CEO View...</div>
                            <div style="color:var(--muted2)">Aggregating data from Marketing, Call Center, and Sales</div>
                            <div class="pill" style="margin-top:15px">Loading...</div>
                        </div>
                    `;
                }

                // Ensure Data is Loaded with validation
                console.log("🔍 CEO View: Checking data sources...");

                // 1. Marketing (loaded on init)
                if (needsMarketing) {
                    console.log("📊 Loading Marketing data...");
                    await init();
                }
                console.log(`✓ Marketing: ${leadRows?.length || 0} leads, ${spendRows?.length || 0} spend rows`);

                // 2. Call Center
                if (needsCC) {
                    console.log("📞 Loading Call Center data...");
                    try {
                        await loadCallCenterData();
                    } catch (e) {
                        console.warn("⚠️ CC Load failed in CEO View", e);
                        globalCCData = []; // Ensure it's at least an empty array
                    }
                }
                console.log(`✓ Call Center: ${globalCCData?.length || 0} records`);

                // 3. Sales
                if (needsSales) {
                    console.log("💼 Loading Sales & Visa data...");
                    try {
                        await loadSalesVisaData();
                    } catch (e) {
                        console.warn("⚠️ Sales Load failed in CEO View", e);
                        window.globalSalesData = []; // Ensure it's at least an empty array
                    }
                }
                console.log(`✓ Sales: ${window.globalSalesData?.length || 0} records`);

                grid.innerHTML = '';
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = 'repeat(3, 1fr)';
                grid.style.gap = '16px';

                // --- 1. Aggregate Data ---
                const { start, end } = getRangeDates();
                console.log(`📅 Date Range: ${start.toISOString().split('T')[0]} to ${end.toISOString().split('T')[0]}`);

                // Helper function to check if date is in range
                const inRange = (d, range) => {
                    if (!d || !range) return false;
                    return d >= range.start && d <= range.end;
                };
                const r = { start, end };

                // === TOTAL LEADS (Same logic as Marketing Dashboard) ===
                // Only count leads WITH Client IDs
                // Marketing: Deduplicate by Client ID (check if already exists)
                // Call Center: Only those with Client ID NOT already in Marketing
                const clientIDsCurr = new Set();

                // Process Marketing leads - only add if they have Client ID AND not duplicate
                (leadRows || []).forEach(row => {
                    const d = parseDateAny(row["Date"]);
                    if (!inRange(d, r)) return;

                    const clientID = row["Client ID"] || row["ClientID"] || row["ID"];
                    if (clientID && !clientIDsCurr.has(clientID)) {
                        clientIDsCurr.add(clientID);
                    }
                    // Leads without Client ID are NOT counted
                    // Duplicate Client IDs are also NOT counted
                });

                // Process Call Center leads - only add if Client ID NOT in Marketing
                (globalCCData || []).forEach(row => {
                    const d = parseDateAny(row["Date"]);
                    if (!inRange(d, r)) return;

                    const clientID = row["Client ID"] || row["ClientID"] || row["ID"];
                    if (clientID && !clientIDsCurr.has(clientID)) {
                        clientIDsCurr.add(clientID);
                    }
                });

                const marketingLeads = clientIDsCurr.size;
                console.log(`📊 Total Leads (unique Client IDs): ${marketingLeads}`);

                const marketingSpend = (spendRows || []).reduce((acc, r) => {
                    const d = parseDateAny(r.Month);
                    if (d && d >= start && d <= end) return acc + safeNum(r["Amount Spent (NPR)"]);
                    return acc;
                }, 0);

                // === HOT LEADS (Call Center) ===
                const ccFiltered = (globalCCData || []).filter(d => {
                    let dt = new Date(d.Date);
                    if (isNaN(dt.getTime())) dt = parseDateAny(d.Date);
                    return dt && dt >= start && dt <= end;
                });
                const ccHot = ccFiltered.filter(d => (d.Stage || "").trim() === "Hot").length;
                console.log(`📞 Hot Leads (CC): ${ccHot}`);

                // === SALES DATA ===
                const allSales = (window.globalSalesData || []);
                console.log(`💼 Total Sales Records: ${allSales.length}`);

                // Sales Active (In Process)
                const salesActive = (window.globalSalesData || []).filter(d => {
                    const stage = (d.Stage || d["Current Stage"] || "").trim();
                    const outcome = (d["Visa Outcome"] || d.Outcome || d.Status || "").trim();
                    const reverted = (d["Reverted to Presales"] || "").trim();
                    const isCompletedStage = ["Completed", "Lost", "Reverted", "Visa Granted"].includes(stage);
                    const isPending = outcome === "Pending" || outcome === "" || outcome === "In Process";
                    const isTerminalOutcome = ["Approved", "Rejected", "Visa Granted", "Lost", "Withdrawn", "Declined", "Reverted"].includes(outcome);

                    if (stage === "Reverted" || outcome === "Reverted" || reverted === "Yes") return false;
                    return isPending && !isTerminalOutcome && !isCompletedStage;
                }).length;


                // Visa Granted (In Period)
                const visaGranted = (window.globalSalesData || []).filter(d => {
                    const outcome = (d["Visa Outcome"] || "").trim();
                    const dStr = d["Completed Date"];
                    let dt = new Date(dStr);
                    if (isNaN(dt.getTime())) dt = parseDateAny(dStr); // Fallback

                    const isGranted = outcome === "Approved" || outcome === "Visa Granted";
                    return isGranted && dt && dt >= start && dt <= end;
                }).length;
                console.log(`💼 Visa Granted in range: ${visaGranted}`);

                // Visa Lodged (In Period) - purely based on status, maybe distinct from Granted
                const visaLodged = (window.globalSalesData || []).filter(d => {
                    const stage = (d["Current Stage"] || "").trim();
                    // If stage is "Visa Lodged" and Active
                    const outcome = (d["Visa Outcome"] || "").trim();
                    return stage === "Visa Lodged" && outcome === "Pending";
                }).length;
                console.log(`💼 Visa Lodged (active): ${visaLodged}`);


                // --- 2. Render KPIs (3 cards only) ---
                grid.insertAdjacentHTML('beforeend', `
                <div class="card kpi" style="border-left: 4px solid #3B82F6">
                    <div class="label">Total Leads</div>
                    <div class="value">${marketingLeads.toLocaleString()}</div>
                    <div class="subtle">Marketing + Call Center</div>
                </div>
                 <div class="card kpi" style="border-left: 4px solid #F59E0B">
                    <div class="label">Hot Leads</div>
                    <div class="value">${ccHot.toLocaleString()}</div>
                    <div class="subtle">Call Center</div>
                </div>
                 <div class="card kpi" style="border-left: 4px solid #10B981">
                    <div class="label">Visa Granted</div>
                    <div class="value">${visaGranted}</div>
                    <div class="subtle">Sales Success</div>
                </div>
            `);

                // Row 2: Funnel Chart (full width)
                grid.insertAdjacentHTML('beforeend', `
                <div class="card chartCard" style="grid-column: span 3">
                    <div class="section-title">🚀 Conversion Funnel (Period)</div>
                    <div class="flex-chart" style="height:300px"><canvas id="ceoFunnelChart"></canvas></div>
                </div>
            `);

                // Row 3: Leaderboard & Bottlenecks
                grid.insertAdjacentHTML('beforeend', `
                <div class="card tableCard" style="grid-column: span 2">
                    <div class="section-title">🏆 Top Performers (Combined)</div>
                    <div class="table-container" style="height:300px; overflow:auto">
                        <table style="width:100%">
                            <thead><tr><th>Rep</th><th>Hot Leads</th><th>Visas</th></tr></thead>
                            <tbody id="ceoLeaderboardBody"></tbody>
                        </table>
                    </div>
                </div>
                 <div class="card chartCard" style="grid-column: span 2">
                    <div class="section-title">⚠️ Process Bottlenecks</div>
                    <div class="subtle">Avg Days in Stage (Active Files)</div>
                    <div class="flex-chart" style="height:300px"><canvas id="ceoBottleneckChart"></canvas></div>
                </div>
            `);


                // --- 3. Render Charts ---

                // Funnel
                if (charts.ceoFunnel) charts.ceoFunnel.destroy();
                const ctxFunnel = $('ceoFunnelChart').getContext('2d');
                charts.ceoFunnel = new Chart(ctxFunnel, {
                    type: 'bar',
                    data: {
                        labels: ['Total Leads', 'Hot Leads', 'Visa Lodged', 'Visa Granted'],
                        datasets: [{
                            label: 'Count',
                            data: [marketingLeads, ccHot, visaLodged, visaGranted],
                            backgroundColor: ['#3B82F6', '#F59E0B', '#6366F1', '#10B981'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94A3B8' } },
                            y: { grid: { display: false }, ticks: { color: '#94A3B8', font: { size: 12, weight: 'bold' } } }
                        }
                    }
                });

                // Leaderboard Logic
                const repStats = {};
                // CC Data
                ccFiltered.forEach(d => {
                    const r = d.Rep || "Unknown";
                    if (!repStats[r]) repStats[r] = { hot: 0, visa: 0 };
                    if ((d.Stage || "").trim() === "Hot") repStats[r].hot++;
                });
                // Sales Data (Window Global) - match roughly by name?
                // Since we don't have a shared ID, name matching is best effort.
                (window.globalSalesData || []).forEach(d => {
                    const r = (d["Sales Rep"] || d.Rep_Name || "Unknown").trim();
                    // Check if granted in period
                    const outcome = (d["Visa Outcome"] || "").trim();
                    const dStr = d["Completed Date"];
                    let dt = new Date(dStr);
                    if (isNaN(dt.getTime())) dt = parseDateAny(dStr);

                    if ((outcome === "Approved" || outcome === "Visa Granted") && dt && dt >= start && dt <= end) {
                        if (!repStats[r]) repStats[r] = { hot: 0, visa: 0 };
                        repStats[r].visa++;
                    }
                });

                const sortedReps = Object.entries(repStats)
                    .map(([name, s]) => ({ name, ...s }))
                    .sort((a, b) => b.visa - a.visa || b.hot - a.hot)
                    .slice(0, 10);

                const lbBody = $('ceoLeaderboardBody');
                lbBody.innerHTML = '';
                sortedReps.forEach(r => {
                    lbBody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td style="font-weight:bold">${r.name}</td>
                        <td>${r.hot}</td>
                        <td style="color:#10B981; font-weight:900">${r.visa}</td>
                    </tr>
                 `);
                });

                // Bottleneck Chart
                // Calculate avg duration for active files in each stage
                // This is tricky without "Stage Entry Date". current data has "Stage Start Date" or similar?
                // Checking Sales Data columns... usually "Stage Start Date"
                const stageDurations = {};
                const stageCounts = {};

                (window.globalSalesData || []).forEach(d => {
                    // Active only
                    const stage = (d["Current Stage"] || "").trim();
                    if (!stage) return;

                    // Calc duration
                    const startStr = d["Stage Start Date"] || d.Date; // Fallback
                    if (!startStr) return;
                    let dt = new Date(startStr);
                    if (isNaN(dt.getTime())) dt = parseDateAny(startStr);
                    if (!dt) return;

                    const now = new Date();
                    const diffDays = Math.floor((now - dt) / (1000 * 60 * 60 * 24));

                    // Filter out crazy outliers (e.g. > 2 years) or negatives
                    if (diffDays < 0 || diffDays > 730) return;

                    if (!stageDurations[stage]) { stageDurations[stage] = 0; stageCounts[stage] = 0; }
                    stageDurations[stage] += diffDays;
                    stageCounts[stage]++;
                });

                const avgStageDurations = Object.keys(stageDurations).map(s => ({
                    stage: s,
                    avg: Math.round(stageDurations[s] / stageCounts[s])
                })).sort((a, b) => b.avg - a.avg).slice(0, 8); // Top bottleneck stages

                if (charts.ceoBottleneck) charts.ceoBottleneck.destroy();
                const ctxBottle = $('ceoBottleneckChart').getContext('2d');
                charts.ceoBottleneck = new Chart(ctxBottle, {
                    type: 'bar',
                    data: {
                        labels: avgStageDurations.map(d => d.stage),
                        datasets: [{
                            label: 'Avg Days',
                            data: avgStageDurations.map(d => d.avg),
                            backgroundColor: '#EF4444'
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94A3B8', autoSkip: false, maxRotation: 90, minRotation: 45 } },
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94A3B8' } }
                        }
                    }
                });

            } catch (err) {
                console.error("CEO View Error:", err);
                grid.innerHTML = `
                    <div class="card" style="grid-column:1/-1; text-align:center; padding:40px">
                        <div style="font-size:24px; margin-bottom:20px; color:var(--bad)">❌ Error Loading CEO View</div>
                        <div style="color:var(--bad); font-weight:800; margin-bottom:20px">${err.message}</div>
                        <button class="btn" style="margin-top:30px" onclick="renderCeoView()">Retry</button>
                    </div>
                `;
            }
        }

    </script>
</body>

</html>